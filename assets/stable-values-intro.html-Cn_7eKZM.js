import{_ as s,c as a,d as e,o as l}from"./app-BaJBWwWi.js";const p={};function t(c,n){return l(),a("div",null,n[0]||(n[0]=[e(`<h3 id="核心目标" tabindex="-1"><a class="header-anchor" href="#核心目标"><span>核心目标</span></a></h3><ul><li>将稳定值的创建与其初始化分离，而不会造成重大性能损失。</li><li>保证稳定值最多初始化一次，即使在多线程程序中也是如此。</li></ul><h3 id="现有问题" tabindex="-1"><a class="header-anchor" href="#现有问题"><span>现有问题</span></a></h3><h4 id="final-字段" tabindex="-1"><a class="header-anchor" href="#final-字段"><span>final 字段</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line"></span>
<span class="line">class OrderController {</span>
<span class="line"></span>
<span class="line">    private final Logger logger = Logger.create(OrderController.class);</span>
<span class="line"></span>
<span class="line">    void submitOrder(User user, List&lt;Product&gt; products) {</span>
<span class="line">        logger.info(&quot;order started&quot;);</span>
<span class="line">        ...</span>
<span class="line">        logger.info(&quot;order submitted&quot;);</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于 logger 是 OrderController 类的 final 字段，因此在创建 OrderController 实例时，必须立刻初始化该字段。这意味着创建新的 OrderController 可能会很慢，毕竟，获取日志记录器有时需要进行昂贵的操作，如读取和解析配置数据，或准备记录日志事件的存储空间。这种初始化工作不仅不利于应用程序的启动，而且可能没有必要。毕竟，有些组件可能永远都不需要记录事件，那么为什么要在前面做这些昂贵的工作呢？</p><h4 id="延迟初始化" tabindex="-1"><a class="header-anchor" href="#延迟初始化"><span>延迟初始化</span></a></h4><p>由于这些原因，我们通常会尽可能推迟复杂对象的初始化时间，以便只在需要时才创建这些对象。我们可以将其初始化移到 getter 方法中。该方法会检查是否已经存在日志对象；如果不存在，则会创建一个新的日志对象，并将其存储在一个 logger 字段中。虽然这种方法可以改善应用程序的启动，但也有一些缺点：</p><ul><li>直接访问 logger 字段可能会暴露一个尚未初始化的字段，从而导致 NullPointerException。</li><li>多线程环境下，可能会导致创建多个日志记录器对象。虽然可以通过一些技术来解决这个问题，但都引入了复杂性，并且存在一些缺点或限制： <ul><li>Class-holder允许常量折叠优化，但它只适用于 static 字段，且每个字段都需要一个单独的持有者类。</li><li>双重检查锁无法应用常量折叠优化，而且必须声明 logger 字段为 volatile。</li></ul></li></ul><h4 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h4><p>我们可能会期望 JVM 通过对已初始化的 logger 字段进行常量折叠访问，或在 getLogger 方法中省略 logger == null 检查等方式来优化对 logger 字段的访问。遗憾的是，由于字段不再是 final，JVM 无法相信其内容在初始更新后永远不会改变。使用可变字段实现的灵活初始化并不高效。</p><p>简而言之，Java 语言允许我们控制字段初始化的方式要么太受约束，要么太不受约束。一方面，final字段受到的约束太强，需要在对象或类的生命周期早期进行初始化，这通常会降低应用程序的启动性能。另一方面，通过使用非final可变字段进行灵活初始化使得推理正确性变得更加困难。不变性和灵活性之间的紧张关系导致开发人员采用不完美的技术，这些技术无法解决根本问题，并导致代码更加脆弱且难以维护。</p><h3 id="稳定值" tabindex="-1"><a class="header-anchor" href="#稳定值"><span>稳定值</span></a></h3><p>稳定值是一个对象，其类型为 StableValue，只保存一个数据值，即其内容。稳定值必须在首次检索其内容之前的一段时间初始化，此后将不可更改。稳定值是实现延迟不变性的一种方法。</p><h4 id="稳定对象" tabindex="-1"><a class="header-anchor" href="#稳定对象"><span>稳定对象</span></a></h4><p>有两种指定初始化的方式：</p><ul><li>使用StableValue::orElseSet()方法在 getter 方法中指定初始化</li><li>使用StableValue.supplier()方法在声明位置指定初始化</li></ul><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 在 getter 方法中指定初始化</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StableValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Logger</span><span class="token punctuation">&gt;</span></span> logger <span class="token operator">=</span> <span class="token class-name">StableValue</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">Logger</span> <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// orElseSet方法保证提供的 lambda 表达式仅计算一次，即使logger.orElseSet(...)同时调用也是如此。</span></span>
<span class="line">        <span class="token keyword">return</span> logger<span class="token punctuation">.</span><span class="token function">orElseSet</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">OrderController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 在声明位置指定初始化</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Logger</span><span class="token punctuation">&gt;</span></span> logger</span>
<span class="line">        <span class="token operator">=</span> <span class="token class-name">StableValue</span><span class="token punctuation">.</span><span class="token function">supplier</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">OrderController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">void</span> <span class="token function">submitOrder</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> products<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        logger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;order started&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line">        logger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;order submitted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="稳定列表" tabindex="-1"><a class="header-anchor" href="#稳定列表"><span>稳定列表</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderController</span><span class="token punctuation">&gt;</span></span> <span class="token constant">ORDERS</span></span>
<span class="line">        <span class="token operator">=</span> <span class="token class-name">StableValue</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token constant">POOL_SIZE</span><span class="token punctuation">,</span> _ <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">OrderController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">OrderController</span> <span class="token function">orders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">long</span> index <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">threadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token constant">POOL_SIZE</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token constant">ORDERS</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,20)]))}const o=s(p,[["render",t]]),r=JSON.parse('{"path":"/java/new-features/stable-values-intro.html","title":"","lang":"zh-CN","frontmatter":{},"git":{"updatedTime":1757914089000,"contributors":[{"name":"zhaomy","username":"zhaomy","email":"3036190149@qq.com","commits":1,"url":"https://github.com/zhaomy"}],"changelog":[{"hash":"0b4ed712e028b2125ee6f1e073cdfe17b60eaeb8","time":1757914089000,"email":"3036190149@qq.com","author":"zhaomy","message":"java 24 、java25 新特性"}]},"filePathRelative":"java/new-features/stable-values-intro.md","excerpt":"<h3>核心目标</h3>\\n<ul>\\n<li>将稳定值的创建与其初始化分离，而不会造成重大性能损失。</li>\\n<li>保证稳定值最多初始化一次，即使在多线程程序中也是如此。</li>\\n</ul>\\n<h3>现有问题</h3>\\n<h4>final 字段</h4>\\n<div class=\\"language-text line-numbers-mode\\" data-highlighter=\\"prismjs\\" data-ext=\\"text\\"><pre><code><span class=\\"line\\"></span>\\n<span class=\\"line\\">class OrderController {</span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">    private final Logger logger = Logger.create(OrderController.class);</span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">    void submitOrder(User user, List&lt;Product&gt; products) {</span>\\n<span class=\\"line\\">        logger.info(\\"order started\\");</span>\\n<span class=\\"line\\">        ...</span>\\n<span class=\\"line\\">        logger.info(\\"order submitted\\");</span>\\n<span class=\\"line\\">    }</span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">}</span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>"}');export{o as comp,r as data};
