---
title: Zookeeper
date: 2025-07-14T01:16:53.997Z
category:
  - arch
  - zookeeper
tags:
  - arch
  - zookeeper
---

# Zookeeper
[[toc]]

<!-- @include:zookeeper_intro.md -->

## 应用场景

Zookeeper主要用于以下场景：
- **服务注册与发现**
- **数据发布/订阅（配置中心）**
- **命名服务**
- 负载均衡
- 集群管理
  + **Master选举**
  + 节点监听 
- 分布式协调与同步
  + 屏障<Tip>DistributedBarrier</Tip>
  + **分布式锁**<Tip>InterProcessMutex</Tip>
- 分布式队列<Tip>DistributedQueue</Tip>

### 服务注册与发现
1. 服务注册  
  服务提供者将自身信息（如IP、端口、元数据）写入ZooKeeper的临时节点，节点随会话生命周期自动清理（服务下线时自动删除）。
2. 服务发现  
  服务消费者通过监听服务提供者的临时节点，获取到服务提供者的最新信息，并进行服务调用。

ZooKeeper的服务注册与发现借鉴了发布/订阅的思想，但因其强一致性设计和特有的ZNode模型，更偏向于实时状态同步而非传统消息发布。对于需要高可靠服务发现的场景（如Dubbo、Kafka的Broker注册），这种模式比通用消息系统更合适。
| 特性	    |       ZooKeeper服务发现	    | 经典发布/订阅（如Kafka） |
|-------|----------|--------|
| 数据模型	  |   层次化节点（ZNode）	    | Topic/Message队列 |
| 触发方式	  |   Watcher事件（一次性触发）	| 消息持久化，多订阅者消费 |
|事件丢失风险  |	较高（需手动处理）       |	较低|
| 数据一致性	  | 强一致性（CP系统）	      | 取决于实现（Kafka是AP） |
| 服务状态管理	| 临时节点自动清理	        | 需额外实现心跳检测 |
| 典型场景	  |   动态服务列表更新	        | 事件广播、日志流 |


#### Watcher 事件的一次性触发机制
Watcher 事件一次性触发是指每个 Watcher 通知只会被触发一次，触发后即自动失效，需要重新注册才能继续监听后续变化。
单次生效原则：
- 当监听的 ZNode 发生变化时，Watcher 会被触发
- 触发后该 Watcher 立即被 ZooKeeper 服务端移除
- 如需继续监听，必须重新设置 Watcher

设计原因：
- 性能考虑： 避免大量未处理的 Watcher 堆积在服务端，减少服务端维护 Watcher 状态的开销
- 简化一致性： 防止因网络问题导致的事件重复，确保客户端每次处理都是最新的状态变化
- 资源控制：防止客户端无限制注册 Watcher 导致内存泄漏

事件丢失风险较高，需客户端自行处理重新注册，有两种解决方案：
- 手动重新注册：客户端在处理变化后重试注册 Watcher
- 使用Curator的自动重新注册：Curator提供了NodeCache，可以自动重新注册 Watcher，实现对 ZNode 数据变化的持续监听。

### 数据发布/订阅（配置中心）

数据发布/订阅系统，即配置中心。需要发布者将数据发布到Zookeeper的节点上，供订阅者进行数据订阅，进而达到动态获取数据的目的，实现配置信息的集中式管理和数据的动态更新。
Zookeeper采用了推拉相结合的模式，客户端向服务端注册自己需要关注的节点，一旦该节点数据发生变更，那么服务端就会向相应的客户端推送Watcher事件通知，客户端接收到此通知后，主动到服务端获取最新的数据。
应用在启动时会主动到Zookeeper服务端上进行一次配置信息的获取，同时，在指定节点上注册一个Watcher监听，这样在配置信息发生变更，服务端都会实时通知所有订阅的客户端，从而达到实时获取最新配置的目的。

### 命名服务
命名服务是指将名称映射到实际资源或服务信息。
- 唯一ID生成
- 全局命名空间
  + 提供统一的资源命名方案
  + 类似DNS但用于分布式系统内部

### 负载均衡
负载均衡是一种相当常见的计算机网络技术，用来对多个计算机、网络连接、CPU、磁盘驱动或其他资源进行分配负载，以达到优化资源使用、最大化吞吐率、最小化响应时间和避免过载的目的。

### 集群管理

#### Master选举

### 分布式协调与同步

#### 屏障
- 分布式系统中同步多个进程
- 实现MapReduce等需要同步的场景

#### 分布式锁
- 排他锁：同一时间只允许一个客户端访问资源 <Tip>InterProcessMutex</Tip>
- 共享锁：多个客户端可同时读取，但写入时独占

### 分布式队列
- 普通队列<Tip>DistributedQueue</Tip>
- 优先级队列：基于节点序列号实现优先级


## 场景选择建议
| 应用场景	| 推荐ZooKeeper特性	      | 替代方案|
|-------|----------|--------|
| 分布式锁	| 临时顺序节点 + Watcher	  | Redis, etcd|
| 配置中心	| 持久节点 + Watcher	    |   Apollo, Nacos|
| 服务发现	| 临时节点 + 子节点监听	      | Eureka, Consul|
| 选举机制	| 临时节点 + 最小序列号策略	    | etcd, Consul|
| 命名服务	| 持久顺序节点	            | 数据库序列|

## 实际应用案例

- Dubbo：服务注册与发现