### 核心原理

Java 对象在堆中的存储包含**对象头**和**实例数据**。对象头又分为：
+ **标记字 (Mark Word)**：存储哈希码、GC 年龄、锁状态、线程持有的锁、偏向线程ID、偏向时间戳等运行时数据。
+ **类指针 (Class Pointer)**：指向对象的类元数据。
+ **数组长度**：数组对象的头部还会额外包含该字段。

在 64 位 JVM 中，普通对象头通常占 **12字节（96位） 至 16字节（128位）**。对于许多平均大小仅为 32-64 字节的小对象来说，对象头的开销占比非常高，可能达到 **20% 到 50%**。JEP 450 通过以下方式将对象头压缩至 **64 位 (8 字节)**：
+ **压缩类指针**：将原本 32 位的压缩类指针进一步优化为 **22 位**，并将其编码嵌入标记字中。
+ **标记字的功能重组与升级**：对固定的 64 位标记字空间进行了彻底的重新规划，将其划分为一个精细的功能位域集合，以同时承载原有和新增的信息
+ **锁机制革新**：传统的**偏向锁** 和**轻量级锁** 会覆盖整个标记字（除锁标记位外），与紧凑对象头中必须保留类指针的设计冲突。因此，**紧凑对象头不再支持偏向锁和栈锁**。它依赖 **JDK 22 中引入的对象监视表** 来管理重量级锁信息。

### 新旧对象头布局对比

为了更直观地理解其变化，可以参考下表对传统对象头与紧凑对象头进行的对比：

#### Java传统对象头

**传统对象头大小**

| 是否压缩 | 对象类型 | 大小 | 说明 |
| :----- | :------ | :-- | :-- |
| 压缩 | 普通对象 | 12字节（96位）   | 标记字8B（64位）+ 类指针4B（32位）|
| 压缩 | 数组对象 | 16字节（128位）  | 标记字8B（64位）+ 类指针4B（32位）<br>+ 数组长度4B（32位） |
| 未压缩 | 普通对象 | 16字节（128位） | 标记字8B（64位）+ 类指针8B（64位） |
| 未压缩 | 数组对象 | 20字节（160位） | 标记字8B（64位）+ 类指针8B（64位）<br>+ 数组长度4B（32位） |

**传统对象头标记字（Mark Word）**

<table>
  <thead>
    <tr>
      <th>状态</th>
      <th>锁状态</th>
      <th>偏向锁</th>
      <th>GC分代<br>年龄</th>
      <th>未使用</th>
      <th>其他</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>无锁状态</td>
      <td>01</td>
      <td>0</td>
      <td>4位</td>
      <td>1位</td>
      <td>哈希码（31位）+ 未使用（25位）</td>
    </tr>
    <tr>
      <td>偏向锁状态</td>
      <td>01</td>
      <td>1</td>
      <td>4位</td>
      <td>1位</td>
      <td>线程ID（54位）+ epoch（2位）</td>
    </tr>
    <tr>
      <td>轻量级锁状态</td>
      <td>00</td>
      <td colspan="4">指向锁记录的指针（62位）</td>
    </tr>
    <tr>
      <td>重量级锁状态</td>
      <td>10</td>
      <td colspan="4">指向Monitor的指针（62位）</td>
    </tr>
    <tr>
      <td>GC 分代年龄</td>
      <td>11</td>
      <td colspan="4">GC所需标记信息</td>
    </tr>
  </tbody>
</table>

#### 紧凑对象头

|标记位|自转发标记位|GC分代年龄|预留|哈希码|压缩类指针|
|:--|:----------|:-------|:---|:----|:-------|
|2位|1位         |4位     |4位  |31位 |22位    |

### 启用方式

Java 24 中，紧凑对象头是实验性功能，需要特定 JVM 参数启用，Java 25 成为正式功能，无需手动启动。

```bash
-XX:+UnlockExperimentalVMOptions -XX:+UseCompactObjectHeaders
```

### 适用场景

紧凑对象头尤其适用于以下场景：
+ **大量小对象**的应用（如微服务、DTO、缓存元素）。
+ **内存敏感型**工作负载（希望降低内存占用和提高部署密度）。
+ **关注缓存效率和高吞吐量**的应用。

在决定是否启用时，需考虑：
+ **应用程序特性**：若应用严重依赖偏向锁，需评估其影响。
+ **GC 选择**：目前该特性主要支持 G1 和 Parallel GC。对于 ZGC 的支持尚未完成。
+ **类加载数量**：确保应用加载的类数量远低于 400 万的上限。