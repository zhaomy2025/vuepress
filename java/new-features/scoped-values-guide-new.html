<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.23" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>从ThreadLocal到ScopedValue：Java上下文管理的架构演进与实战指南 | My Blog</title><meta name="description" content="这是我的第一个 VuePress 站点">
    <link rel="preload" href="/assets/style-CnXJ9Nmb.css" as="style"><link rel="stylesheet" href="/assets/style-CnXJ9Nmb.css">
    <link rel="modulepreload" href="/assets/app-C07FBv5C.js"><link rel="modulepreload" href="/assets/scoped-values-guide-new.html-DsyeYAkZ.js">
    <link rel="prefetch" href="/assets/index.html-BjP1X5p8.js" as="script"><link rel="prefetch" href="/assets/index.html-DVwUDjNv.js" as="script"><link rel="prefetch" href="/assets/index.html-TN5rq9p1.js" as="script"><link rel="prefetch" href="/assets/git-hooks.html-C-3kpJNZ.js" as="script"><link rel="prefetch" href="/assets/git-ssh.html-CxHejwyA.js" as="script"><link rel="prefetch" href="/assets/index.html--BzGM-wA.js" as="script"><link rel="prefetch" href="/assets/index.html-DkHTVSBt.js" as="script"><link rel="prefetch" href="/assets/index.html-Dqyjm3At.js" as="script"><link rel="prefetch" href="/assets/yaml.html-B75HClPk.js" as="script"><link rel="prefetch" href="/assets/functools.html-DusuCYbL.js" as="script"><link rel="prefetch" href="/assets/functools_wraps.html-CTAxkQtl.js" as="script"><link rel="prefetch" href="/assets/index.html-CyJSm9uF.js" as="script"><link rel="prefetch" href="/assets/requirements.html-CHOqYt23.js" as="script"><link rel="prefetch" href="/assets/wrapper.html-CXaViogj.js" as="script"><link rel="prefetch" href="/assets/book-name-format.html-B4PHB9ef.js" as="script"><link rel="prefetch" href="/assets/book.html-DKFQrLIH.js" as="script"><link rel="prefetch" href="/assets/github.html-DCPa2yPa.js" as="script"><link rel="prefetch" href="/assets/index.html-BLAQJ6hT.js" as="script"><link rel="prefetch" href="/assets/vscode-plugins.html-SFN6ALho.js" as="script"><link rel="prefetch" href="/assets/windows-tools.html-BvGMD_GE.js" as="script"><link rel="prefetch" href="/assets/code_tool_template.html-Byfgdx5B.js" as="script"><link rel="prefetch" href="/assets/index.html-CF6x_Fse.js" as="script"><link rel="prefetch" href="/assets/tool_template.html-pn6OZHWA.js" as="script"><link rel="prefetch" href="/assets/tutorial_website_setup_template.html-g2rVCSUk.js" as="script"><link rel="prefetch" href="/assets/index.html-9-q7EHXD.js" as="script"><link rel="prefetch" href="/assets/todo.html-D2N2irnV.js" as="script"><link rel="prefetch" href="/assets/coze.html-IYyRG6dx.js" as="script"><link rel="prefetch" href="/assets/index.html--bI6-_uV.js" as="script"><link rel="prefetch" href="/assets/instruction.html-D_HqlrNk.js" as="script"><link rel="prefetch" href="/assets/prompt.html-V1Nt5GC8.js" as="script"><link rel="prefetch" href="/assets/quesion.html-mREdHxmF.js" as="script"><link rel="prefetch" href="/assets/trae-plugin.html-Bn-MDyuC.js" as="script"><link rel="prefetch" href="/assets/github_action.html-D435-O9C.js" as="script"><link rel="prefetch" href="/assets/index.html-DKQxh3eV.js" as="script"><link rel="prefetch" href="/assets/database-connection-pool.html-BTVtBKm5.js" as="script"><link rel="prefetch" href="/assets/index.html-CP5cUnMM.js" as="script"><link rel="prefetch" href="/assets/multithreading.html-B9BS0O3d.js" as="script"><link rel="prefetch" href="/assets/multithreading_intro.html-OGuW3Tn2.js" as="script"><link rel="prefetch" href="/assets/linked-hash-map-to-object.html-CpIyvAXG.js" as="script"><link rel="prefetch" href="/assets/index.html-4bZ_xQRs.js" as="script"><link rel="prefetch" href="/assets/java_mail.html-iGy46ZMi.js" as="script"><link rel="prefetch" href="/assets/java_mail_sender.html-BiJWo_U7.js" as="script"><link rel="prefetch" href="/assets/mail.html-DlK43Tt8.js" as="script"><link rel="prefetch" href="/assets/mail_smtp.html-DJdIQctW.js" as="script"><link rel="prefetch" href="/assets/ahead-of-time-method-profiling-intro.html-n418RUVZ.js" as="script"><link rel="prefetch" href="/assets/class-file-api-intro.html-CXsCIk6t.js" as="script"><link rel="prefetch" href="/assets/compact-object-headers-intro.html-3UEQc8iS.js" as="script"><link rel="prefetch" href="/assets/flexible-constructor-bodies-intro.html-3FFgqUK_.js" as="script"><link rel="prefetch" href="/assets/generational-shenandoah-intro.html-Bj9xqCCU.js" as="script"><link rel="prefetch" href="/assets/index.html-s8L02wE4.js" as="script"><link rel="prefetch" href="/assets/java-22-features.html-DcktbSaH.js" as="script"><link rel="prefetch" href="/assets/java-23-features.html-CB5OGLOO.js" as="script"><link rel="prefetch" href="/assets/java-24-features.html-CI0HCn4A.js" as="script"><link rel="prefetch" href="/assets/java-25-features.html-C2M5TwGT.js" as="script"><link rel="prefetch" href="/assets/jep-445-463-477-495-512-intro.html-CG9oBf7P.js" as="script"><link rel="prefetch" href="/assets/jfr-cooperative-sampling-intro.html-DWYX60PR.js" as="script"><link rel="prefetch" href="/assets/module-Import-declarations-intro.html-VCNqccoF.js" as="script"><link rel="prefetch" href="/assets/prepare-to-restrict-the-use-of-jni-intro.html-DmKbU-ED.js" as="script"><link rel="prefetch" href="/assets/primitive-types-in-patterns-instanceof-and-switch-intro.html-fUH4SjzZ.js" as="script"><link rel="prefetch" href="/assets/primitive-types-in-patterns-instanceof-and-switch.html-DSHBDQ8s.js" as="script"><link rel="prefetch" href="/assets/scoped-values-guide-intro.html-u5X7YHPu.js" as="script"><link rel="prefetch" href="/assets/scoped-values-guide.html-CUtIsXM3.js" as="script"><link rel="prefetch" href="/assets/stable-values-intro.html-1YFmi0eG.js" as="script"><link rel="prefetch" href="/assets/stream-gatherers-guide-intro.html-aJosLxtV.js" as="script"><link rel="prefetch" href="/assets/stream-gatherers-guide.html-Do1B55oJ.js" as="script"><link rel="prefetch" href="/assets/structured-concurrency-guide.html-C43lty-Y.js" as="script"><link rel="prefetch" href="/assets/structured-concurrency-intro.html-BgFFR4h0.js" as="script"><link rel="prefetch" href="/assets/vector-api-guide.html-OlpUm1bL.js" as="script"><link rel="prefetch" href="/assets/vector-api-intro.html-DsjUmAV6.js" as="script"><link rel="prefetch" href="/assets/index.html-CYFZJRW8.js" as="script"><link rel="prefetch" href="/assets/mybatis-annotation.html-Cmo4Tnv9.js" as="script"><link rel="prefetch" href="/assets/mybatis-intro.html-DZh0Kb3n.js" as="script"><link rel="prefetch" href="/assets/mybatis-plus-code-generator.html-DgUGpHUD.js" as="script"><link rel="prefetch" href="/assets/mybatis-plus-multi-tenant.html-DQDC0jWN.js" as="script"><link rel="prefetch" href="/assets/mybatis-plus-pagehelper.html-Dty_SEI2.js" as="script"><link rel="prefetch" href="/assets/mybatis.html-BdM27Sjp.js" as="script"><link rel="prefetch" href="/assets/apache_common.html-C_-KmjqI.js" as="script"><link rel="prefetch" href="/assets/file.html-ZMirNlSn.js" as="script"><link rel="prefetch" href="/assets/file_utils.html-C3JHY37f.js" as="script"><link rel="prefetch" href="/assets/hutool.html-_YTkmuVN.js" as="script"><link rel="prefetch" href="/assets/index.html-Dn2g-iep.js" as="script"><link rel="prefetch" href="/assets/index.html-CnHHf381.js" as="script"><link rel="prefetch" href="/assets/dynamic-programming-intro.html-fFubJIr-.js" as="script"><link rel="prefetch" href="/assets/dynamic-programming.html-DKQNFJPi.js" as="script"><link rel="prefetch" href="/assets/index.html-B0ZW5KWn.js" as="script"><link rel="prefetch" href="/assets/index.html-CuxHDb5e.js" as="script"><link rel="prefetch" href="/assets/index.html-DZakFQxt.js" as="script"><link rel="prefetch" href="/assets/command.html-CNQMsTyT.js" as="script"><link rel="prefetch" href="/assets/index.html-v5cD7dSf.js" as="script"><link rel="prefetch" href="/assets/index.html-KmiwYzfv.js" as="script"><link rel="prefetch" href="/assets/spring-boot-hello-world-intro.html-BeHuuhPd.js" as="script"><link rel="prefetch" href="/assets/spring-boot-hello-world.html-Bb4d2eCp.js" as="script"><link rel="prefetch" href="/assets/spring-boot-oracle.html-hOYqTDgW.js" as="script"><link rel="prefetch" href="/assets/spring-boot-redis-intro.html-COSxLP9K.js" as="script"><link rel="prefetch" href="/assets/spring-boot-redis.html-DrTJRcM_.js" as="script"><link rel="prefetch" href="/assets/spring-boot.html-k6BVPtwt.js" as="script"><link rel="prefetch" href="/assets/spring-framework-aop-impi.html-EpUBE6mk.js" as="script"><link rel="prefetch" href="/assets/spring-framework-aop.html-fMkleHy6.js" as="script"><link rel="prefetch" href="/assets/spring-framework-ioc-impi.html-4snN-L9j.js" as="script"><link rel="prefetch" href="/assets/spring-framework-ioc.html-DVzuvvrl.js" as="script"><link rel="prefetch" href="/assets/spring-framework.html-eYmvqfJw.js" as="script"><link rel="prefetch" href="/assets/common_markdown.html-mI36Ekht.js" as="script"><link rel="prefetch" href="/assets/common_summary.html-DdVySPb6.js" as="script"><link rel="prefetch" href="/assets/css.html-VpRSixSR.js" as="script"><link rel="prefetch" href="/assets/index.html-BHG6hX_k.js" as="script"><link rel="prefetch" href="/assets/plugin.html-D8WXodFG.js" as="script"><link rel="prefetch" href="/assets/vue-component.html-CeEFG4ro.js" as="script"><link rel="prefetch" href="/assets/vuepress_cloud.html-CDuN4vkh.js" as="script"><link rel="prefetch" href="/assets/index.html-DEW7amjX.js" as="script"><link rel="prefetch" href="/assets/nvm.html-D84XTUzY.js" as="script"><link rel="prefetch" href="/assets/microservices.html-Cnqecx1V.js" as="script"><link rel="prefetch" href="/assets/mockito-advanced.html-CBVhTEah.js" as="script"><link rel="prefetch" href="/assets/spring-boot.html-COSfM-jR.js" as="script"><link rel="prefetch" href="/assets/testcontainers-mysql.html-CT8_Ju9w.js" as="script"><link rel="prefetch" href="/assets/assertj.html-CyypJRch.js" as="script"><link rel="prefetch" href="/assets/cucumber.html-VHIoK8JW.js" as="script"><link rel="prefetch" href="/assets/junit-5.html-UCbtfw4A.js" as="script"><link rel="prefetch" href="/assets/mockito.html-DjLk03Nn.js" as="script"><link rel="prefetch" href="/assets/n8n-springboot.html-Cs-XAbPC.js" as="script"><link rel="prefetch" href="/assets/rest-assured.html-DlGaEYqJ.js" as="script"><link rel="prefetch" href="/assets/selenium.html-D0T2Y50n.js" as="script"><link rel="prefetch" href="/assets/spring-boot-test.html-CV8t-y84.js" as="script"><link rel="prefetch" href="/assets/testcontainers.html-DgMvnV8E.js" as="script"><link rel="prefetch" href="/assets/testng.html-DUzqqrdg.js" as="script"><link rel="prefetch" href="/assets/ai-testing.html-BuyKQXlU.js" as="script"><link rel="prefetch" href="/assets/e2e-testing.html-B8jnavl4.js" as="script"><link rel="prefetch" href="/assets/integration-testing.html-C5Q7Bi6h.js" as="script"><link rel="prefetch" href="/assets/tdd.html-BdsNiKCh.js" as="script"><link rel="prefetch" href="/assets/test-coverage.html-sqX8rvCj.js" as="script"><link rel="prefetch" href="/assets/unit-testing.html-C0elEtVp.js" as="script"><link rel="prefetch" href="/assets/jacoco.html-CdAERKlS.js" as="script"><link rel="prefetch" href="/assets/pitest.html-B8ZoBvZN.js" as="script"><link rel="prefetch" href="/assets/sonarqube.html-DSAIk7Sy.js" as="script"><link rel="prefetch" href="/assets/index.html-B-L4cMke.js" as="script"><link rel="prefetch" href="/assets/requirement_v1.html-CSqIAKxB.js" as="script"><link rel="prefetch" href="/assets/fastjson2.html-D9c3DCkD.js" as="script"><link rel="prefetch" href="/assets/jackson.html-DI5ANozT.js" as="script"><link rel="prefetch" href="/assets/index.html-BtO_D8by.js" as="script"><link rel="prefetch" href="/assets/itexpdf.html-Bh-erFf8.js" as="script"><link rel="prefetch" href="/assets/index.html-BDtUkxh3.js" as="script"><link rel="prefetch" href="/assets/load-balance.html-CbE_C4Z-.js" as="script"><link rel="prefetch" href="/assets/suggest.html-DPbzVFyi.js" as="script"><link rel="prefetch" href="/assets/client.html-CIOYvNCu.js" as="script"><link rel="prefetch" href="/assets/command.html-DSrT71-Z.js" as="script"><link rel="prefetch" href="/assets/curator.html-DDDL3qjv.js" as="script"><link rel="prefetch" href="/assets/index.html-DvWTDSCE.js" as="script"><link rel="prefetch" href="/assets/zkclient.html-DATV2KdJ.js" as="script"><link rel="prefetch" href="/assets/zookeeper_intro.html-Bx-Culqe.js" as="script"><link rel="prefetch" href="/assets/index.html-CeWdLNl0.js" as="script"><link rel="prefetch" href="/assets/multi-tenant.html-7tURG0Aw.js" as="script"><link rel="prefetch" href="/assets/constraint.html-CjupcB53.js" as="script"><link rel="prefetch" href="/assets/cursor.html-CXQvvc8T.js" as="script"><link rel="prefetch" href="/assets/cursor_intro.html-D21XUWFv.js" as="script"><link rel="prefetch" href="/assets/index.html-BVcsuxax.js" as="script"><link rel="prefetch" href="/assets/index.html-DzHQzHWl.js" as="script"><link rel="prefetch" href="/assets/tencent-nginx.html-DTQ0Ir_1.js" as="script"><link rel="prefetch" href="/assets/tencent.html-Bmw-k_Cm.js" as="script"><link rel="prefetch" href="/assets/index.html-DLsfwX8X.js" as="script"><link rel="prefetch" href="/assets/nginx-problem.html-B3rTE5CU.js" as="script"><link rel="prefetch" href="/assets/nginx.html-DjHiRjR1.js" as="script"><link rel="prefetch" href="/assets/index.html-B7F0OODk.js" as="script"><link rel="prefetch" href="/assets/snowflake.html-B_5mCCQR.js" as="script"><link rel="prefetch" href="/assets/index.html-iRSockjZ.js" as="script"><link rel="prefetch" href="/assets/404.html-Dwo61Umc.js" as="script"><link rel="prefetch" href="/assets/index.html-DhrrQ_9v.js" as="script"><link rel="prefetch" href="/assets/index.html-qpLlTMfY.js" as="script"><link rel="prefetch" href="/assets/index.html-BeMxBDa3.js" as="script"><link rel="prefetch" href="/assets/index.html-TSpricnZ.js" as="script"><link rel="prefetch" href="/assets/index.html-2QILQTtp.js" as="script"><link rel="prefetch" href="/assets/index.html-DOHPCLS5.js" as="script"><link rel="prefetch" href="/assets/index.html-j2iOMH-f.js" as="script"><link rel="prefetch" href="/assets/index.html-CNN1mFXF.js" as="script"><link rel="prefetch" href="/assets/index.html-Cvpsz63j.js" as="script"><link rel="prefetch" href="/assets/index.html-E5JIhGgm.js" as="script"><link rel="prefetch" href="/assets/index.html-C2qwG2CL.js" as="script"><link rel="prefetch" href="/assets/index.html-DVpMViZZ.js" as="script"><link rel="prefetch" href="/assets/index.html-gAx1RHI3.js" as="script"><link rel="prefetch" href="/assets/index.html-BJfVwrGS.js" as="script"><link rel="prefetch" href="/assets/index.html-CHRi-5is.js" as="script"><link rel="prefetch" href="/assets/index.html-C2qwG2CL.js" as="script"><link rel="prefetch" href="/assets/index.html-DVpMViZZ.js" as="script"><link rel="prefetch" href="/assets/index.html-tuFVwl7P.js" as="script"><link rel="prefetch" href="/assets/index.html-BBai7Z28.js" as="script"><link rel="prefetch" href="/assets/index.html-jTjospNb.js" as="script"><link rel="prefetch" href="/assets/index.html-DFhAGOmK.js" as="script"><link rel="prefetch" href="/assets/index.html-C58jYTV7.js" as="script"><link rel="prefetch" href="/assets/index.html-BlrVxUTn.js" as="script"><link rel="prefetch" href="/assets/index.html-CGuAZbU_.js" as="script"><link rel="prefetch" href="/assets/index.html-CBn10-we.js" as="script"><link rel="prefetch" href="/assets/index.html-CQdJ2b5z.js" as="script"><link rel="prefetch" href="/assets/index.html-CuIYp-xH.js" as="script"><link rel="prefetch" href="/assets/index.html-C8D2LTEN.js" as="script"><link rel="prefetch" href="/assets/index.html-CSvFD8Q7.js" as="script"><link rel="prefetch" href="/assets/index.html-DZ0-LR6T.js" as="script"><link rel="prefetch" href="/assets/index.html-B6CHS553.js" as="script"><link rel="prefetch" href="/assets/index.html-DEQzgXf2.js" as="script"><link rel="prefetch" href="/assets/index.html-BfM3-Osm.js" as="script"><link rel="prefetch" href="/assets/index.html-BuNw_-8Q.js" as="script"><link rel="prefetch" href="/assets/index.html-vmVTvjPK.js" as="script"><link rel="prefetch" href="/assets/index.html-CGHhwgq4.js" as="script"><link rel="prefetch" href="/assets/index.html-BGRM1kd8.js" as="script"><link rel="prefetch" href="/assets/index.html-DBRLwRpu.js" as="script"><link rel="prefetch" href="/assets/index.html-sCNAFySH.js" as="script"><link rel="prefetch" href="/assets/index.html-voCgDaVy.js" as="script"><link rel="prefetch" href="/assets/index.html-DupXn80P.js" as="script"><link rel="prefetch" href="/assets/index.html-Dj-kRkC-.js" as="script"><link rel="prefetch" href="/assets/index.html-D_QsXQZk.js" as="script"><link rel="prefetch" href="/assets/index.html-CZLZaYeE.js" as="script"><link rel="prefetch" href="/assets/index.html-BurN_FSg.js" as="script"><link rel="prefetch" href="/assets/mermaid.esm.min-D2VG8kRv.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><img class="vp-site-logo" src="/images/logo.png" alt="My Blog"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">My Blog</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/resource/" aria-label="资源"><!--[--><!--[--><!--]--><!--]-->资源<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/java/" aria-label="Java"><!--[--><!--[--><!--]--><!--]-->Java<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/spring/" aria-label="Spring"><!--[--><!--[--><!--]--><!--]-->Spring<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/arch/" aria-label="架构"><!--[--><!--[--><!--]--><!--]-->架构<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/db/" aria-label="数据库"><!--[--><!--[--><!--]--><!--]-->数据库<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/algorithm/" aria-label="算法"><!--[--><!--[--><!--]--><!--]-->算法<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/linux/" aria-label="Linux"><!--[--><!--[--><!--]--><!--]-->Linux<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/git/" aria-label="Git"><!--[--><!--[--><!--]--><!--]-->Git<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/vuepress/" aria-label="VuePress"><!--[--><!--[--><!--]--><!--]-->VuePress<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/others/" aria-label="杂项"><!--[--><!--[--><!--]--><!--]-->杂项<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/resource/" aria-label="资源"><!--[--><!--[--><!--]--><!--]-->资源<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/java/" aria-label="Java"><!--[--><!--[--><!--]--><!--]-->Java<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/spring/" aria-label="Spring"><!--[--><!--[--><!--]--><!--]-->Spring<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/arch/" aria-label="架构"><!--[--><!--[--><!--]--><!--]-->架构<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/db/" aria-label="数据库"><!--[--><!--[--><!--]--><!--]-->数据库<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/algorithm/" aria-label="算法"><!--[--><!--[--><!--]--><!--]-->算法<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/linux/" aria-label="Linux"><!--[--><!--[--><!--]--><!--]-->Linux<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/git/" aria-label="Git"><!--[--><!--[--><!--]--><!--]-->Git<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/vuepress/" aria-label="VuePress"><!--[--><!--[--><!--]--><!--]-->VuePress<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/others/" aria-label="杂项"><!--[--><!--[--><!--]--><!--]-->杂项<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading" href="/java/" aria-label="Java"><!--[--><!--[--><!--]--><!--]-->Java<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading" href="/java/new-features/" aria-label="Java 新特性"><!--[--><!--[--><!--]--><!--]-->Java 新特性<!--[--><!--[--><!--]--><!--]--></a><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/new-features/java-25-features.html" aria-label="Java 25 新特性"><!--[--><!--[--><!--]--><!--]-->Java 25 新特性<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/new-features/java-24-features.html" aria-label="Java 24 新特性"><!--[--><!--[--><!--]--><!--]-->Java 24 新特性<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/new-features/java-23-features.html" aria-label="Java 23 新特性"><!--[--><!--[--><!--]--><!--]-->Java 23 新特性<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/new-features/java-22-features.html" aria-label="Java 22 新特性"><!--[--><!--[--><!--]--><!--]-->Java 22 新特性<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/java/intermediate/" aria-label="Java 中级"><!--[--><!--[--><!--]--><!--]-->Java 中级<!--[--><!--[--><!--]--><!--]--></a><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/intermediate/multithreading.html" aria-label="Java 多线程编程"><!--[--><!--[--><!--]--><!--]-->Java 多线程编程<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">工具库 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/utils/file_utils.html" aria-label="FileUtils"><!--[--><!--[--><!--]--><!--]-->FileUtils<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/utils/pdf_utils/" aria-label="PDFUtils"><!--[--><!--[--><!--]--><!--]-->PDFUtils<!--[--><!--[--><!--]--><!--]--></a><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/utils/pdf_utils/itexpdf.html" aria-label="itexpdf"><!--[--><!--[--><!--]--><!--]-->itexpdf<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/utils/apache_common.html" aria-label="Apache Common"><!--[--><!--[--><!--]--><!--]-->Apache Common<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/utils/hutool.html" aria-label="hutool"><!--[--><!--[--><!--]--><!--]-->hutool<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">ORM <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/orm/mybatis.html" aria-label="MyBatis"><!--[--><!--[--><!--]--><!--]-->MyBatis<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/orm/mybatis-annotation.html" aria-label="MyBatis/MyBatis-Plus注解"><!--[--><!--[--><!--]--><!--]-->MyBatis/MyBatis-Plus注解<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">模块 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/module/mail.html" aria-label="Java 邮件服务"><!--[--><!--[--><!--]--><!--]-->Java 邮件服务<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/module/java_mail.html" aria-label="JavaMail"><!--[--><!--[--><!--]--><!--]-->JavaMail<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/module/java_mail_sender.html" aria-label="JavaMailSender"><!--[--><!--[--><!--]--><!--]-->JavaMailSender<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">其他 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><p tabindex="0" class="vp-sidebar-item">Json <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/misc/json/fastjson2.html" aria-label="fastjson2"><!--[--><!--[--><!--]--><!--]-->fastjson2<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/misc/json/jackson.html" aria-label="Jackson库详解"><!--[--><!--[--><!--]--><!--]-->Jackson库详解<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/misc/linked-hash-map-to-object.html" aria-label="LinkedHashMap解析"><!--[--><!--[--><!--]--><!--]-->LinkedHashMap解析<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div id="content"><h1 id="从threadlocal到scopedvalue-java上下文管理的架构演进与实战指南" tabindex="-1"><a class="header-anchor" href="#从threadlocal到scopedvalue-java上下文管理的架构演进与实战指南"><span>从ThreadLocal到ScopedValue：Java上下文管理的架构演进与实战指南</span></a></h1><blockquote><p>探索Java并发编程中上下文管理的范式革命，理解从线程绑定到作用域绑定的设计哲学转变,掌握Java 25正式版的完整技术生态</p></blockquote><h2 id="技术背景与问题分析" tabindex="-1"><a class="header-anchor" href="#技术背景与问题分析"><span>技术背景与问题分析</span></a></h2><p>在现代Java应用架构中，上下文传递一直是构建可维护、高性能并发系统的核心挑战。随着微服务架构和响应式编程的普及，这一挑战变得更加复杂。</p><h3 id="threadlocal的架构局限性" tabindex="-1"><a class="header-anchor" href="#threadlocal的架构局限性"><span>ThreadLocal的架构局限性</span></a></h3><p>ThreadLocal自Java 1.2引入以来，成为上下文管理的标准方案，但其设计上的局限性在大规模分布式系统中暴露无遗：</p><p><strong>架构视角下的ThreadLocal缺陷分析</strong>：</p><table><thead><tr><th>问题维度</th><th>ThreadLocal表现</th><th>架构影响</th><th>严重程度</th></tr></thead><tbody><tr><td>内存管理</td><td>生命周期与线程绑定，无法自动清理</td><td>线程池环境中导致持续内存泄露，GC压力增大</td><td>⚠️⚠️⚠️⚠️⚠️</td></tr><tr><td>并发模型适配</td><td>与现代并发模型（虚拟线程、结构化并发）不兼容</td><td>阻碍应用迁移到Project Loom带来的性能优势</td><td>⚠️⚠️⚠️⚠️</td></tr><tr><td>线程安全</td><td>依赖开发者手动维护不可变性</td><td>增加并发错误风险，破坏系统稳定性</td><td>⚠️⚠️⚠️⚠️</td></tr><tr><td>组合性</td><td>缺乏结构化的上下文组合机制</td><td>代码复杂度高，难以维护多维度上下文</td><td>⚠️⚠️⚠️⚠️</td></tr><tr><td>可观测性</td><td>上下文传播路径难以追踪和调试</td><td>生产环境问题定位困难，增加运维成本</td><td>⚠️⚠️⚠️</td></tr></tbody></table><blockquote><p>ThreadLocal生命周期与线程绑定，而线程池中线程长期存活，导致ThreadLocal不能自动清理，造成<strong>内存泄露</strong>；因此需要手动调用 <code>remove()</code>显式清理，但容易在异常分支中遗漏，存在<strong>生命周期管理复杂问题</strong>；线程重用同时也会导致前一个任务的 <code>ThreadLocal</code>值<strong>污染</strong>后一个任务</p></blockquote><blockquote><p>ThreadLocal 的「线程安全」是基于副本隔离的，仅当存储的对象是「不可变对象」时，才能真正保证「线程安全且不可篡改」；若存储「可变对象」，则： 线程内部修改会破坏该线程内的副本一致性； 线程外部拿到副本引用后，会直接破坏线程隔离，导致跨线程篡改。</p></blockquote><h3 id="threadlocal的代码示例" tabindex="-1"><a class="header-anchor" href="#threadlocal的代码示例"><span>ThreadLocal的代码示例</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalProblems</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 问题1：内存泄露风险</span></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatabaseConnection</span><span class="token punctuation">&gt;</span></span> connectionHolder <span class="token operator">=</span></span>
<span class="line">      <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token annotation punctuation">@Override</span></span>
<span class="line">          <span class="token keyword">protected</span> <span class="token class-name">DatabaseConnection</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DatabaseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会自动清理</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 问题2：线程池中的值污染</span></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> userContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">demonstrateProblems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">          userContext<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;user123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 后续任务可能看到这个值</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token class-name">String</span> user <span class="token operator">=</span> userContext<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可能得到&quot;user123&quot;！</span></span>
<span class="line">          <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected user: &quot;</span> <span class="token operator">+</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 问题3：ThreadLocal 值可以被任意修改，破坏线程安全</span></span>
<span class="line">    <span class="token comment">// 3.1 线程内部修改会破坏该线程内的副本一致性，尤其是经过多层调用后，误修改难以发现（问题5：上下文传播路径难以追踪和调试）</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> userRoles <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> userRoles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        roles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置 USER 角色</span></span>
<span class="line">        <span class="token function">otherMethod</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用其他方法，修改 roles</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userRoles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ADMIN] — 被意外修改！</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">otherMethod</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        roles<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        roles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;ADMIN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 3.2 对象引用泄露到其他线程</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserSession</span><span class="token punctuation">&gt;</span></span> session <span class="token operator">=</span></span>
<span class="line">            <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">UserSession</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">UserSession</span> currentSession <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 主线程默认会话 ID 为 default</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Main thread now: &quot;</span> <span class="token operator">+</span> currentSession<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;New thread sees: &quot;</span> <span class="token operator">+</span> currentSession<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 在其他线程中修改会话 ID</span></span>
<span class="line">            currentSession<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token string">&quot;hacked_by_other_thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 主线程再次获取会话 ID，已被修改为 hacked_by_other_thread</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Main thread now: &quot;</span> <span class="token operator">+</span> <span class="token class-name">LeakyContext</span><span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 问题4：复杂的多层上下文传递</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">complexContextChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            userContext<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;user1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            transactionContext<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;tx1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            localeContext<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;en_US&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 每层都需要手动清理</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>
<span class="line">            userContext<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            transactionContext<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            localeContext<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="演进路线详解-scopedvalue的设计哲学" tabindex="-1"><a class="header-anchor" href="#演进路线详解-scopedvalue的设计哲学"><span>演进路线详解：ScopedValue的设计哲学</span></a></h2><p>ScopedValue代表了Java上下文管理从&quot;线程绑定&quot;到&quot;作用域绑定&quot;的根本性转变，这不仅是API的变更，更是设计哲学的演进。</p><h3 id="java上下文管理的演进时间线" tabindex="-1"><a class="header-anchor" href="#java上下文管理的演进时间线"><span>Java上下文管理的演进时间线</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Java 1.2 (1998) ──────────────────────────────────► Java 25 (2024)</span>
<span class="line">    │                                                 │</span>
<span class="line">    │ ThreadLocal引入                                 │ ScopedValue正式版</span>
<span class="line">    │ 线程绑定上下文                                  │ 作用域绑定上下文</span>
<span class="line">    │                                                 │</span>
<span class="line">    └─────────────► Java 20 (2023) ──────────────┘</span>
<span class="line">                      │</span>
<span class="line">                      │ ScopedValue孵化 (JEP 429)</span>
<span class="line">                      │</span>
<span class="line">                      └─────────────► Java 21-24</span>
<span class="line">                                         │</span>
<span class="line">                                         │ 预览版迭代优化</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Java 20：孵化期探索</strong></p><ul><li><strong>Java 20：JEP 429孵化</strong></li></ul><p><strong>Java 21-24：预览版</strong></p><ul><li><strong>Java 21：JEP 446预览</strong>，无 API 变更</li><li><strong>Java 22：JEP 464第二次预览</strong>，无 API 变更</li><li><strong>Java 23：JEP 481第三次预览</strong>，<code>ScopedValue.callWhere</code> 方法的操作参数类型现在改为一个新的函数式接口，这使得 Java 编译器能够推断是否可能抛出受检异常。基于这一改动，<code>ScopedValue.getWhere</code> 方法不再需要，现已被移除</li><li><strong>Java 24：JEP 487第四次预览</strong>，移除了 <code>ScopedValue</code> 类中的 <code>callWhere</code> 和 <code>runWhere</code> 方法，使 API 保持完全流畅的链式调用特性。现在使用一个或多个绑定作用域值的唯一方式是通过 <code>ScopedValue.Carrier.call</code> 和 <code>ScopedValue.Carrier.run</code> 方法</li></ul><p><strong>Java 25：正式版发布</strong></p><ul><li><strong>Java 25：JEP 464正式版</strong>，<code>ScopedValue.orElse</code> 方法不再接受 <code>null</code>作为其参数</li></ul><h3 id="scopedvalue的核心设计原则" tabindex="-1"><a class="header-anchor" href="#scopedvalue的核心设计原则"><span>ScopedValue的核心设计原则</span></a></h3><ol><li><strong>作用域语义优先</strong>：上下文绑定到代码块而非线程，符合函数式编程的资源管理思想</li><li><strong>自动生命周期管理</strong>：JVM保证作用域退出时自动清理，从根本上<strong>避免内存泄露</strong></li><li><strong>结构化并发集成</strong>：与虚拟线程和结构化并发API无缝协作</li><li><strong>不可变性保证</strong>：值一旦设置不可修改，提供线程安全保障</li><li><strong>组合性设计</strong>：支持优雅的上下文组合和嵌套</li></ol><p>ScopedValue的设计体现了Java平台对现代应用架构需求的深刻理解。这不是简单的API替换，而是Java团队对&quot;如何更好地支持大规模分布式系统&quot;这一问题的系统思考。</p><h2 id="核心api" tabindex="-1"><a class="header-anchor" href="#核心api"><span>核心API</span></a></h2><p>创建</p><ul><li>ScopedValue.newInstance(): 创建新的 ScopedValue 实例</li><li>ScopedValue.withInitial():</li></ul><p>绑定与执行API</p><ul><li>ScopedValue.where(key, value)</li><li>ScopedValue.where(bindings)</li><li>ScopedValue.Carrier.where(key, value)</li><li>ScopedValue.Carrier.run(() -&gt; {...})</li><li>ScopedValue.Carrier.call(() -&gt; {...})</li></ul><blockquote><p>ScopedValue.where(key, value) 返回 ScopedValue.Carrier，可以链式调用 ScopedValue.where(key, value).run(() -&gt; {...}): 在新作用域中绑定值并执行代码块 ScopedValue.where(key, value).call(() -&gt; {...}): 在新作用域中绑定值并执行代码块 ScopedValue.where(bindings).run(() -&gt; {...}): 在新作用域中绑定值并执行代码块 ScopedValue.where(bindings).call(() -&gt; {...}): 在新作用域中绑定值并执行代码块 ScopedValue.where(key1, value1).where(key2, value2).call(() -&gt; {...}): 在新作用域中绑定值并执行代码块</p></blockquote><p>状态查询API</p><ul><li>ScopedValue.isBound(key): 判断「当前线程的作用域栈中，是否已绑定该 ScopedValue 实例」</li><li>ScopedValue.get(key): 获取当前线程作用域栈中绑定的 ScopedValue 值</li><li>get()：: 获取当前线程作用域栈中绑定的 ScopedValue 值</li></ul><p>工具方法API</p><ul><li>orElse(key, defaultValue): 如果当前线程作用域栈中未绑定该 ScopedValue 实例，则返回 defaultValue</li><li>orElseGet(key, supplier): 如果当前线程作用域栈中未绑定该 ScopedValue 实例，则通过 supplier 函数获取值</li></ul><p>注意：</p><ul><li>ScopedValue一般放在类的静态字段中，确保在当前类的所有方法中都可以访问到</li></ul><h2 id="核心原理与架构解析" tabindex="-1"><a class="header-anchor" href="#核心原理与架构解析"><span>核心原理与架构解析</span></a></h2><h3 id="三大核心原则" tabindex="-1"><a class="header-anchor" href="#三大核心原则"><span>三大核心原则</span></a></h3><p>ScopedValue 并非 ThreadLocal 的简单替代，而是 JVM 为「虚拟线程（Virtual Thread）」量身设计的上下文传递机制，其设计遵循三大核心原则：</p><ul><li>作用域绑定（Scope-Bound）：上下文仅在 call() 方法定义的作用域内有效，执行完毕自动清理（天然避免内存泄漏）</li><li>高效传播（Efficient Propagation）：适配虚拟线程的 M:N 调度模型，上下文传递无需拷贝，仅通过引用关联实现父子线程（虚拟线程）的继承</li><li>不可变性（Immutability）：ScopedValue 实例不可修改（无 set 方法），绑定的值仅在当前作用域内有效，子作用域无法篡改父作用域的值</li></ul><h3 id="三大关键组件的详细设计-架构层面拆解" tabindex="-1"><a class="header-anchor" href="#三大关键组件的详细设计-架构层面拆解"><span>三大关键组件的详细设计（架构层面拆解）</span></a></h3><h4 id="绑定管理器-binding-manager-作用域的-创建-查找-清理-中枢" tabindex="-1"><a class="header-anchor" href="#绑定管理器-binding-manager-作用域的-创建-查找-清理-中枢"><span>绑定管理器（Binding Manager）：作用域的 “创建 - 查找 - 清理” 中枢</span></a></h4><ul><li>设计目标：替代 ThreadLocal 的 ThreadLocalMap，解决「线程级存储导致的内存冗余」问题，实现「作用域级存储」。</li><li>核心设计细节： <ul><li>数据结构：JVM 层面维护「线程私有作用域栈（Scope Stack）」，每个线程（包括虚拟线程）都有一个独立的栈，栈元素是「绑定集合（BindingSet）」。 <ul><li>BindingSet：本质是一个轻量级哈希表（或数组，基于 ScopedValue.id 索引），存储当前作用域内所有 ScopedValue 的「id - value」映射；</li><li>栈结构特性：<code>ScopedValue.where().call()</code> 方法调用时，创建新的 BindingSet 压入栈顶；call() 执行完毕（无论正常返回还是异常），自动弹出栈顶 BindingSet 并销毁（天然清理，无内存泄漏）。</li></ul></li><li>id 分配机制： <ul><li>简化模型中的 allocateId() 是 JVM 层面的全局唯一 ID 生成器（基于原子类自增），确保每个 ScopedValue 实例的 id 全局唯一；</li><li>查找时直接通过 id 索引 BindingSet（O (1) 复杂度），比 ThreadLocalMap 的哈希冲突处理更高效。</li></ul></li></ul></li><li>优势： <ul><li>无 GC 压力：退出作用域即释放，无需弱引用清理</li><li>无内存泄漏：不像 ThreadLocal 需要手动 remove()</li></ul></li></ul><h4 id="上下文传播机制-context-propagation-虚拟线程的-无拷贝继承" tabindex="-1"><a class="header-anchor" href="#上下文传播机制-context-propagation-虚拟线程的-无拷贝继承"><span>上下文传播机制（Context Propagation）：虚拟线程的 “无拷贝继承”</span></a></h4><ul><li>设计目标：适配虚拟线程的 M:N 调度（多个虚拟线程映射到少量载体线程），解决 ThreadLocal 上下文切换时的「拷贝开销」和「一致性问题」。</li><li>核心设计细节： <ul><li>父子作用域继承模型： <ul><li>当虚拟线程 A 调用 <code>ScopedValue.call()</code> 创建作用域后，若在该作用域内创建子虚拟线程 B，JVM 会让 B 的「作用域栈」继承 A 的栈（共享父栈的 BindingSet 引用，而非拷贝）；</li><li>子线程 B 可新增自己的 BindingSet（压入栈顶），但修改仅在自身作用域内有效，不会影响父线程 A 的上下文（栈隔离特性）。</li></ul></li><li>虚拟线程调度的上下文一致性： <ul><li>虚拟线程切换时（从载体线程 X 迁移到载体线程 Y），无需拷贝 ScopedValue 的上下文 —— 因为「作用域栈」是虚拟线程私有数据，与载体线程解耦；</li><li>JVM 在调度虚拟线程时，会自动将其「作用域栈」与当前载体线程关联，确保 ScopedValue.get() 能正确找到当前栈顶的 BindingSet。</li></ul></li></ul></li></ul><h4 id="内存屏障-memory-barrier-作用域的-可见性与原子性保障" tabindex="-1"><a class="header-anchor" href="#内存屏障-memory-barrier-作用域的-可见性与原子性保障"><span>内存屏障（Memory Barrier）：作用域的 “可见性与原子性保障”</span></a></h4><ul><li>设计目标：解决「作用域退出时的资源释放可见性」和「不可变性的线程安全」问题，避免指令重排序导致的上下文错乱。</li><li>核心设计细节： <ul><li>作用域切换的内存屏障： <ul><li>当 call() 方法执行 ScopeStack.push() 时，JVM 插入「写屏障」，确保 BindingSet 的绑定操作（put）对后续 get() 操作可见；</li><li>当执行 ScopeStack.pop() 时，插入「读屏障」，确保所有线程（包括切换后的载体线程）都能感知到「当前作用域已失效」，避免出现「作用域已退出但仍能读取旧值」的脏读。</li></ul></li></ul></li><li>不可变性的底层保障： <ul><li>ScopedValue 实例被设计为 final（无 set 方法），绑定的值一旦存入 BindingSet，就无法被修改（BindingSet 是只读结构，仅允许 put 一次）；</li><li>内存屏障禁止「绑定操作」与「执行目标逻辑」的指令重排序，确保目标逻辑执行时，ScopedValue 的值已完全绑定。</li></ul></li><li>异常场景的原子清理： <ul><li>若 call() 中的目标逻辑抛出异常，finally 块的 pop() 仍会执行，配合内存屏障，确保 BindingSet 被原子性销毁，避免部分绑定残留。</li></ul></li></ul><h3 id="核心设计与-threadlocal-的关键差异-架构优势总结" tabindex="-1"><a class="header-anchor" href="#核心设计与-threadlocal-的关键差异-架构优势总结"><span>核心设计与 ThreadLocal 的关键差异（架构优势总结）</span></a></h3><table><thead><tr><th>设计维度</th><th>ThreadLocal</th><th>ScopedValue</th></tr></thead><tbody><tr><td>存储粒度</td><td>线程级（每个线程一个 ThreadLocalMap）</td><td>作用域级（每个作用域一个 BindingSet）</td></tr><tr><td>清理机制</td><td>手动 remove() 或线程销毁（易泄漏）</td><td>作用域退出自动弹栈（无泄漏）</td></tr><tr><td>上下文传播</td><td>线程副本拷贝（虚拟线程切换开销大）</td><td>父子作用域引用共享（无拷贝）</td></tr><tr><td>不可变性保障</td><td>无（存储可变对象易被篡改）</td><td>天然支持（无 set 方法，BindingSet 只读）</td></tr><tr><td>内存开销</td><td>高（百万虚拟线程对应百万 Map）</td><td>低（BindingSet 随作用域复用销毁）</td></tr><tr><td>底层依赖</td><td>应用层哈希表（ThreadLocalMap）</td><td>JVM 层面作用域栈 + 内存屏障</td></tr></tbody></table><h2 id="scopedvalue-的应用场景与核心特性实践" tabindex="-1"><a class="header-anchor" href="#scopedvalue-的应用场景与核心特性实践"><span>ScopedValue 的应用场景与核心特性实践</span></a></h2><h3 id="递归调用与复杂嵌套场景下的scopedvalue行为" tabindex="-1"><a class="header-anchor" href="#递归调用与复杂嵌套场景下的scopedvalue行为"><span>递归调用与复杂嵌套场景下的ScopedValue行为</span></a></h3><p>在递归调用和复杂嵌套作用域场景下，ScopedValue展现出卓越的设计优势，这是传统ThreadLocal难以实现的：</p><ol><li><strong>递归调用中的作用域隔离</strong>：</li></ol><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">// 递归调用中的ScopedValue行为示例</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RecursiveScopedValueExample</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ScopedValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">DEPTH</span> <span class="token operator">=</span> <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">calculateFactorial</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 设置当前递归深度</span></span>
<span class="line">        <span class="token keyword">int</span> currentDepth <span class="token operator">=</span> <span class="token constant">DEPTH</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token constant">DEPTH</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token constant">DEPTH</span><span class="token punctuation">,</span> currentDepth<span class="token punctuation">)</span></span>
<span class="line">                          <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;递归深度: &quot;</span> <span class="token operator">+</span> <span class="token constant">DEPTH</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> n <span class="token operator">*</span> <span class="token function">calculateFactorial</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">calculateFactorial</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;5! = &quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 输出将显示每个递归层级的独立作用域和深度值</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>深度嵌套的性能稳定性：O(1) 栈操作 vs O(n) 哈希查找</strong></li></ol><p>ScopedValue在JVM层面采用了栈式管理机制，嵌套时仅需压入 / 弹出作用域栈，查找通过 id 索引直接定位，时间复杂度 O(1)，即使在深度嵌套场景下也能保持高效的查找和清理性能。而 ThreadLocal 在深度嵌套时需遍历 ThreadLocalMap（可能触发 rehash），最坏 O(n)。测试表明，即使在1000层嵌套的极端场景下，ScopedValue 的查找耗时和内存占用增长远低于 ThreadLocal。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">// 多层嵌套作用域性能测试</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nestedScopesPerformance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_DEPTH</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ScopedValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">LEVEL</span> <span class="token operator">=</span> <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 递归创建嵌套作用域</span></span>
<span class="line">    <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> createNestedScopes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token annotation punctuation">@Override</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> depth<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">&gt;=</span> <span class="token constant">MAX_DEPTH</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token constant">LEVEL</span><span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">                      <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">assert</span> <span class="token constant">LEVEL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  </span>
<span class="line">    <span class="token comment">// 开始测试</span></span>
<span class="line">    <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    createNestedScopes<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">long</span> endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;创建&quot;</span> <span class="token operator">+</span> <span class="token constant">MAX_DEPTH</span> <span class="token operator">+</span> <span class="token string">&quot;层嵌套作用域耗时: &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>endTime <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1_000_000</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong>局部覆盖与全局上下文保持：声明式上下文切换</strong></li></ol><p>在复杂业务流程中，ScopedValue支持临时覆盖上下文值，退出作用域后自动恢复原值，不影响外层作用域。 架构价值：</p><ul><li>避免创建多个 ThreadLocal 变量来模拟“模式切换”；</li><li>上下文变更范围精确限定在代码块内，提升可读性与可维护性；</li><li>天然支持 AOP 式的横切关注点（如审计、限流、多租户）。</li></ul><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">businessWorkflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">ScopedValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">USER_CONTEXT</span> <span class="token operator">=</span> <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ScopedValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">OPERATION_MODE</span> <span class="token operator">=</span> <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 设置全局上下文</span></span>
<span class="line">    <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token constant">USER_CONTEXT</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span></span>
<span class="line">              <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token constant">OPERATION_MODE</span><span class="token punctuation">,</span> <span class="token string">&quot;normal&quot;</span><span class="token punctuation">)</span></span>
<span class="line">              <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;全局上下文: &quot;</span> <span class="token operator">+</span> <span class="token constant">USER_CONTEXT</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token constant">OPERATION_MODE</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">executeStandardOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 仅覆盖 MODE，USER 保持不变</span></span>
<span class="line">        <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token constant">OPERATION_MODE</span><span class="token punctuation">,</span> <span class="token string">&quot;elevated&quot;</span><span class="token punctuation">)</span></span>
<span class="line">                  <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;特殊操作上下文: &quot;</span> <span class="token operator">+</span> <span class="token constant">USER_CONTEXT</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token constant">OPERATION_MODE</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">executeSpecialOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 自动恢复为 normal 模式</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;恢复全局上下文: &quot;</span> <span class="token operator">+</span> <span class="token constant">USER_CONTEXT</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token constant">OPERATION_MODE</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="结构化并发与-scopedvalue-的协同应用" tabindex="-1"><a class="header-anchor" href="#结构化并发与-scopedvalue-的协同应用"><span>结构化并发与 ScopedValue 的协同应用</span></a></h3><p>ScopedValue 与 Java 结构化并发（StructuredTaskScope）的协同，是新一代并发模型的核心优势 —— 结构化并发的 “任务父子关系” 与 ScopedValue 的 “作用域继承” 天然契合，实现上下文的自动传播与安全清理，这是 ThreadLocal 无法实现的（ThreadLocal 需手动配置线程池上下文传递，且易因任务取消导致泄漏）。 核心协同特性：</p><ul><li>子任务自动继承上下文：结构化并发中，fork 创建的子任务会自动继承父任务的 ScopedValue 上下文，无需手动传递参数或绑定线程。</li><li>任务取消 / 异常时的上下文清理：当 StructuredTaskScope 取消子任务或抛出异常时，子任务对应的 ScopedValue 作用域会随任务终止自动清理，无内存残留。</li><li>上下文一致性保障：所有子任务共享同一父上下文，且子任务的局部覆盖不会影响其他子任务或父任务。</li></ul><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">// 结构化并发与ScopedValue的协同工作</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">processOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 设置全局追踪上下文</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token constant">TRACE_ID</span><span class="token punctuation">,</span> <span class="token function">generateTraceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                     <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token constant">ORDER_ID</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span></span>
<span class="line">                     <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructuredTaskScope<span class="token punctuation">.</span>ShutdownOnFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 并行任务自动继承上下文</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CustomerInfo</span><span class="token punctuation">&gt;</span></span> customerTask <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">fetchCustomerInfo</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InventoryStatus</span><span class="token punctuation">&gt;</span></span> inventoryTask <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">checkInventory</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PaymentResult</span><span class="token punctuation">&gt;</span></span> paymentTask <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">processPayment</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待所有子任务完成</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// 构建响应，所有任务共享相同上下文</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">buildOrderResponse</span><span class="token punctuation">(</span></span>
<span class="line">                customerTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                inventoryTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                paymentTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="异常场景下的-scopedvalue-清理机制与上下文稳定性" tabindex="-1"><a class="header-anchor" href="#异常场景下的-scopedvalue-清理机制与上下文稳定性"><span>异常场景下的 ScopedValue：清理机制与上下文稳定性</span></a></h3><p>ScopedValue 在异常处理上的核心优势的是 “语言级别的资源清理保障”—— 无论正常执行、异常抛出还是任务取消，作用域退出时都会自动清理绑定值，从根本上解决 ThreadLocal 依赖手动 remove() 导致的内存泄漏问题。其行为特性可分为三类场景：</p><ol><li><strong>单作用域异常：可靠的自动清理</strong></li></ol><p>无论执行过程中是否发生异常，ScopedValue都会在作用域退出时自动清理绑定的值。这是通过JVM级别的try-with-resources类似机制实现的，确保不会发生内存泄漏。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">// 单作用域异常清理示例</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processWithException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 无默认值的 ScopedValue：作用域退出后 get() 抛 NoSuchElementException</span></span>
<span class="line">    <span class="token class-name">ScopedValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SESSION_ID</span> <span class="token operator">=</span> <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 有默认值的 ScopedValue：作用域退出后 get() 返回默认值</span></span>
<span class="line">    <span class="token class-name">ScopedValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">APP_MODE</span> <span class="token operator">=</span> <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token constant">SESSION_ID</span><span class="token punctuation">,</span> <span class="token string">&quot;abc123&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token constant">APP_MODE</span><span class="token punctuation">,</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 模拟业务逻辑</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行中：&quot;</span> <span class="token operator">+</span> <span class="token constant">SESSION_ID</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token constant">APP_MODE</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// 模拟业务异常</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;业务处理失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// 以下代码不会执行</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;This won&#39;t be executed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;捕获到异常: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 无默认值的 ScopedValue 抛异常</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token constant">SESSION_ID</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;验证：异常发生后ScopedValue已被正确清理&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">// 有默认值的 ScopedValue 返回默认值</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;验证2：有默认值的 ScopedValue 返回默认值：&quot;</span> <span class="token operator">+</span> <span class="token constant">APP_MODE</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>嵌套作用域异常：上下文隔离与恢复</strong> 嵌套作用域中，内层作用域抛出异常后，仅会清理内层绑定值，外层作用域的上下文保持不变 —— 体现 “栈式隔离” 特性，内层修改不会污染外层。</li></ol><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">// 嵌套作用域异常：内层清理不影响外层</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nestedScopesWithException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">ScopedValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">REQUEST_ID</span> <span class="token operator">=</span> <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ScopedValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">USER_ID</span> <span class="token operator">=</span> <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token constant">REQUEST_ID</span><span class="token punctuation">,</span> <span class="token string">&quot;req-123&quot;</span><span class="token punctuation">)</span></span>
<span class="line">                  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token constant">USER_ID</span><span class="token punctuation">,</span> <span class="token string">&quot;user-456&quot;</span><span class="token punctuation">)</span></span>
<span class="line">                  <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;外层作用域: &quot;</span> <span class="token operator">+</span> <span class="token constant">REQUEST_ID</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token constant">USER_ID</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// 嵌套作用域：临时覆盖 USER_ID</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token constant">USER_ID</span><span class="token punctuation">,</span> <span class="token string">&quot;user-modified&quot;</span><span class="token punctuation">)</span></span>
<span class="line">                          <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;内层作用域: &quot;</span> <span class="token operator">+</span> <span class="token constant">REQUEST_ID</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token constant">USER_ID</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;内层异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;内层异常被捕获: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// 验证内层作用域退出后，外层作用域的值恢复</span></span>
<span class="line">                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;外层作用域恢复: &quot;</span> <span class="token operator">+</span> <span class="token constant">REQUEST_ID</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token constant">USER_ID</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;外层异常: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong>与ThreadLocal的根本区别</strong> ThreadLocal依赖开发者在finally块中显式清理，而ScopedValue通过语言级别的设计确保无论何种异常路径都会执行清理操作。这从根本上解决了ThreadLocal在异常场景下的内存泄漏问题。</li></ol><p>从架构设计角度看，ScopedValue的异常处理机制体现了&quot;防御式编程&quot;的最佳实践，将资源管理与业务逻辑分离，减少了人为错误的可能性。这在高可用系统设计中尤为重要，可以显著提高系统的稳定性和可维护性。</p><h2 id="实践指导与迁移策略" tabindex="-1"><a class="header-anchor" href="#实践指导与迁移策略"><span>实践指导与迁移策略</span></a></h2><h3 id="从threadlocal到scopedvalue的三阶段迁移" tabindex="-1"><a class="header-anchor" href="#从threadlocal到scopedvalue的三阶段迁移"><span>从ThreadLocal到ScopedValue的三阶段迁移</span></a></h3><p>基于我们在多个大型项目中的实践经验，推荐采用以下迁移策略：</p><p><strong>阶段1：评估与准备（1-2周）</strong></p><ul><li>审计现有ThreadLocal使用场景，按风险等级分类</li><li>识别ThreadLocal清理不完整的代码路径</li><li>建立性能基准测试，为迁移效果提供对比依据</li></ul><p><strong>阶段2：增量替换（2-4周）</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">// 迁移示例：Web过滤器上下文管理</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebContextFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 旧方案：ThreadLocal</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebContext</span><span class="token punctuation">&gt;</span></span> <span class="token constant">CONTEXT_TL</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 新方案：ScopedValue</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ScopedValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebContext</span><span class="token punctuation">&gt;</span></span> <span class="token constant">CONTEXT_SV</span> <span class="token operator">=</span> <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> </span>
<span class="line">            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">WebContext</span> context <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 方案A：完全ThreadLocal（迁移前）</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token constant">CONTEXT_TL</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token constant">CONTEXT_TL</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 手动清理，容易遗漏</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 方案B：完全ScopedValue（迁移后）</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token constant">CONTEXT_SV</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">ServletException</span> <span class="token operator">|</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> e<span class="token punctuation">;</span> <span class="token comment">// 保持原类型</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> e<span class="token punctuation">;</span> <span class="token comment">// 显式透传，防止被下一分支包装</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 理论上不会发生（doFilter 只抛出 IOException/ServletException）</span></span>
<span class="line">            <span class="token comment">// 但为满足编译器要求，需处理</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected checked exception in filter&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token comment">// 自动清理，无需try-finally</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>阶段3：优化与强化（持续进行）</strong></p><ul><li>利用ScopedValue的结构化特性重构代码</li><li>引入更丰富的上下文对象模型</li><li>实现AOP切面自动管理作用域</li></ul><h3 id="企业级最佳实践" tabindex="-1"><a class="header-anchor" href="#企业级最佳实践"><span>企业级最佳实践</span></a></h3><p>在金融、电商等高并发领域的实践中，我们总结出以下最佳实践：</p><ol><li><strong>上下文分层设计</strong>：按功能领域划分作用域值，避免单一全局上下文</li></ol><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">// 推荐：分层上下文设计</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContextLayers</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 核心层：安全与身份</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ScopedValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserPrincipal</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SECURITY_CONTEXT</span> <span class="token operator">=</span> <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 业务层：请求与事务</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ScopedValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestContext</span><span class="token punctuation">&gt;</span></span> <span class="token constant">REQUEST_CONTEXT</span> <span class="token operator">=</span> <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 技术层：追踪与监控</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ScopedValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TraceContext</span><span class="token punctuation">&gt;</span></span> <span class="token constant">TRACE_CONTEXT</span> <span class="token operator">=</span> <span class="token class-name">ScopedValue</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>异常处理增强</strong>：结合作用域值实现更丰富的异常上下文</li></ol><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">// 异常处理增强</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EnhancedExceptionHandler</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerExceptionResolver</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">resolveException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> </span>
<span class="line">                                        <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 从作用域值获取上下文信息丰富异常</span></span>
<span class="line">        <span class="token class-name">String</span> requestId <span class="token operator">=</span> <span class="token class-name">RequestContext</span><span class="token punctuation">.</span><span class="token constant">REQUEST_ID</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token string">&quot;unknown&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> userId <span class="token operator">=</span> <span class="token class-name">SecurityContext</span><span class="token punctuation">.</span><span class="token constant">USER_ID</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token string">&quot;anonymous&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Request {} by user {} failed: {}&quot;</span><span class="token punctuation">,</span> requestId<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 构建包含上下文信息的错误响应</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">buildErrorResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> ex<span class="token punctuation">,</span> requestId<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="架构影响与性能评估" tabindex="-1"><a class="header-anchor" href="#架构影响与性能评估"><span>架构影响与性能评估</span></a></h2><h3 id="对应用架构的深远影响" tabindex="-1"><a class="header-anchor" href="#对应用架构的深远影响"><span>对应用架构的深远影响</span></a></h3><p>ScopedValue的引入对Java应用架构产生了多方面的积极影响：</p><ol><li><strong>微服务可观测性提升</strong>：通过标准化的上下文传递，简化分布式追踪实现</li><li><strong>虚拟线程性能充分发挥</strong>：避免ThreadLocal在线程池中积累导致的内存问题</li><li><strong>代码质量与可维护性</strong>：明确的作用域边界使代码结构更清晰</li><li><strong>架构演进支持</strong>：为响应式编程和事件驱动架构提供更好的上下文管理支持</li></ol><h2 id="未来展望" tabindex="-1"><a class="header-anchor" href="#未来展望"><span>未来展望</span></a></h2><p>展望未来，ScopedValue的发展方向可能包括：</p><ol><li><strong>API进一步简化</strong>：更流畅的链式调用和声明式用法</li><li><strong>编译期优化</strong>：JIT编译器对ScopedValue访问的专门优化</li><li><strong>可视化调试工具</strong>：IDE和监控工具对作用域的可视化支持</li><li><strong>扩展到更多场景</strong>：如响应式流处理、计算引擎等</li></ol><p>从架构演进的角度看，ScopedValue代表了Java向更现代、更安全、更高效的并发模型迈进的重要一步。它不仅仅是对ThreadLocal的替代，更是对Java平台如何支持云原生应用的深度思考。</p><h2 id="结语" tabindex="-1"><a class="header-anchor" href="#结语"><span>结语</span></a></h2><p>ScopedValue的引入标志着Java上下文管理的范式革命，从线程绑定转向作用域绑定，从手动管理转向自动生命周期管理。这一转变不仅解决了ThreadLocal的历史遗留问题，更为构建下一代高性能、可维护的Java应用提供了坚实基础。</p><p>对于系统架构师和技术决策者而言，尽早规划从ThreadLocal到ScopedValue的迁移，将为应用带来显著的性能、稳定性和可维护性提升。让我们拥抱这一技术演进，构建更加高效、可靠的Java应用架构。</p><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料"><span>参考资料</span></a></h2><ul><li><a href="https://openjdk.org/jeps/429" target="_blank" rel="noopener noreferrer">JEP 429: Scoped Values (Incubator)</a></li><li><a href="https://openjdk.org/jeps/446" target="_blank" rel="noopener noreferrer">JEP 446: Scoped Values (Preview)</a></li><li><a href="https://openjdk.org/jeps/464" target="_blank" rel="noopener noreferrer">JEP 464: Scoped Values (Second Preview)</a></li><li><a href="https://openjdk.org/jeps/481" target="_blank" rel="noopener noreferrer">JEP 481: Scoped Values (Third Preview)</a></li><li><a href="https://openjdk.org/jeps/487" target="_blank" rel="noopener noreferrer">JEP 487: Scoped Values (Fourth Preview)</a></li><li><a href="https://openjdk.org/jeps/506" target="_blank" rel="noopener noreferrer">JEP 506: Scoped Values</a></li></ul></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">最近更新：: </span><time class="meta-item-info" datetime="2025-11-25T06:47:24.000Z" data-allow-mismatch>2025/11/25 06:47</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 3036190149@qq.com">zhaomy</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-C07FBv5C.js" defer></script>
  </body>
</html>
