<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.23" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>结构化并发：Java并发编程的革命性演进 | My Blog</title><meta name="description" content="这是我的第一个 VuePress 站点">
    <link rel="preload" href="/assets/style-CnXJ9Nmb.css" as="style"><link rel="stylesheet" href="/assets/style-CnXJ9Nmb.css">
    <link rel="modulepreload" href="/assets/app-DhQSeJGz.js"><link rel="modulepreload" href="/assets/structured-concurrency-guide.html-nsFFhhUF.js">
    <link rel="prefetch" href="/assets/index.html-5FpkDd4k.js" as="script"><link rel="prefetch" href="/assets/get-started.html-qZkMWgGz.js" as="script"><link rel="prefetch" href="/assets/index.html-CGtOk7bN.js" as="script"><link rel="prefetch" href="/assets/git-hooks.html-B4mN9p1o.js" as="script"><link rel="prefetch" href="/assets/git-ssh.html-Bt7Ehx9B.js" as="script"><link rel="prefetch" href="/assets/index.html-DnUS0CEC.js" as="script"><link rel="prefetch" href="/assets/index.html-p1mdFPj6.js" as="script"><link rel="prefetch" href="/assets/functools.html-D9G4iDq2.js" as="script"><link rel="prefetch" href="/assets/functools_wraps.html-DwKOow8u.js" as="script"><link rel="prefetch" href="/assets/index.html-Ca74lZ38.js" as="script"><link rel="prefetch" href="/assets/requirements.html-e_rt797K.js" as="script"><link rel="prefetch" href="/assets/wrapper.html-BkoheQM-.js" as="script"><link rel="prefetch" href="/assets/book-name-format.html-DlXNYxXg.js" as="script"><link rel="prefetch" href="/assets/book.html-C01CkNyC.js" as="script"><link rel="prefetch" href="/assets/github.html-tfFUdDSg.js" as="script"><link rel="prefetch" href="/assets/index.html-BYkXz9YC.js" as="script"><link rel="prefetch" href="/assets/code_tool_template.html-P6KuxGps.js" as="script"><link rel="prefetch" href="/assets/index.html-CZ8yTFXN.js" as="script"><link rel="prefetch" href="/assets/tool_template.html-Db2cuzyx.js" as="script"><link rel="prefetch" href="/assets/tutorial_website_setup_template.html-BOLiDe6O.js" as="script"><link rel="prefetch" href="/assets/coze.html-C2WacXKb.js" as="script"><link rel="prefetch" href="/assets/index.html-BknxOtfc.js" as="script"><link rel="prefetch" href="/assets/instruction.html-BS67tj7c.js" as="script"><link rel="prefetch" href="/assets/prompt.html-CI4M_V3M.js" as="script"><link rel="prefetch" href="/assets/quesion.html-DraL1wSF.js" as="script"><link rel="prefetch" href="/assets/trae-plugin.html-XOv4l6_A.js" as="script"><link rel="prefetch" href="/assets/github_action.html-B01Gqjy1.js" as="script"><link rel="prefetch" href="/assets/index.html-eBfq6I76.js" as="script"><link rel="prefetch" href="/assets/database-connection-pool.html-D5w662pB.js" as="script"><link rel="prefetch" href="/assets/index.html-CtnEiLkT.js" as="script"><link rel="prefetch" href="/assets/multithreading.html-DJp66dRI.js" as="script"><link rel="prefetch" href="/assets/multithreading_intro.html-DpyHO9pa.js" as="script"><link rel="prefetch" href="/assets/fastjson2.html-GiaLnFCM.js" as="script"><link rel="prefetch" href="/assets/jackson.html-BNh_MmHI.js" as="script"><link rel="prefetch" href="/assets/linked-hash-map-to-object.html-ajkqd9BD.js" as="script"><link rel="prefetch" href="/assets/index.html-UgYJOELU.js" as="script"><link rel="prefetch" href="/assets/java_mail.html-jdXyy1kY.js" as="script"><link rel="prefetch" href="/assets/java_mail_sender.html-Ci-8eWXW.js" as="script"><link rel="prefetch" href="/assets/mail.html-BcA58mUf.js" as="script"><link rel="prefetch" href="/assets/mail_smtp.html-DYqFOeUg.js" as="script"><link rel="prefetch" href="/assets/ahead-of-time-method-profiling-intro.html-DttU1x5k.js" as="script"><link rel="prefetch" href="/assets/class-file-api-intro.html-DKTzXcMt.js" as="script"><link rel="prefetch" href="/assets/compact-object-headers-intro.html-CKikEd83.js" as="script"><link rel="prefetch" href="/assets/flexible-constructor-bodies-intro.html-CKvolY41.js" as="script"><link rel="prefetch" href="/assets/generational-shenandoah-intro.html-Cr3x4nGH.js" as="script"><link rel="prefetch" href="/assets/index.html-DGKDgQGx.js" as="script"><link rel="prefetch" href="/assets/java-22-features.html-C12_edFG.js" as="script"><link rel="prefetch" href="/assets/java-23-features.html-GDjQgjdG.js" as="script"><link rel="prefetch" href="/assets/java-24-features.html-Dbush08Z.js" as="script"><link rel="prefetch" href="/assets/java-25-features.html-CLec682b.js" as="script"><link rel="prefetch" href="/assets/jer-445-463-477-495-512-intro.html-4vh1TLcs.js" as="script"><link rel="prefetch" href="/assets/jfr-cooperative-sampling-intro.html-B-Zrajdx.js" as="script"><link rel="prefetch" href="/assets/module-Import-declarations-intro.html-BeMUdWz6.js" as="script"><link rel="prefetch" href="/assets/prepare-to-restrict-the-use-of-jni-intro.html-DatpiLys.js" as="script"><link rel="prefetch" href="/assets/primitive-types-in-patterns-instanceof-and-switch-intro.html-DgjCm1a1.js" as="script"><link rel="prefetch" href="/assets/primitive-types-in-patterns-instanceof-and-switch.html-B6z7uUEy.js" as="script"><link rel="prefetch" href="/assets/stable-values-intro.html-Dnje7X0b.js" as="script"><link rel="prefetch" href="/assets/structured-concurrency-intro.html-BTkWncLa.js" as="script"><link rel="prefetch" href="/assets/vector-api-intro.html-VhMEHb6U.js" as="script"><link rel="prefetch" href="/assets/index.html-B3zQjIU6.js" as="script"><link rel="prefetch" href="/assets/mybatis-annotation.html-w59z7pL2.js" as="script"><link rel="prefetch" href="/assets/mybatis-intro.html-D9T1k2f4.js" as="script"><link rel="prefetch" href="/assets/mybatis-plus-code-generator.html-DGLHXiol.js" as="script"><link rel="prefetch" href="/assets/mybatis-plus-multi-tenant.html-D1zwRDcg.js" as="script"><link rel="prefetch" href="/assets/mybatis-plus-pagehelper.html-DuA7pHnq.js" as="script"><link rel="prefetch" href="/assets/mybatis.html-DiiDRTL2.js" as="script"><link rel="prefetch" href="/assets/apache_common.html-CRugiaWS.js" as="script"><link rel="prefetch" href="/assets/file.html-DW7iUgWN.js" as="script"><link rel="prefetch" href="/assets/file_utils.html-CV8jHTuP.js" as="script"><link rel="prefetch" href="/assets/hutool.html-Df_LIpvU.js" as="script"><link rel="prefetch" href="/assets/index.html-DiVfCxwQ.js" as="script"><link rel="prefetch" href="/assets/index.html-DGnopxwm.js" as="script"><link rel="prefetch" href="/assets/dynamic-programming-intro.html-B347XhuZ.js" as="script"><link rel="prefetch" href="/assets/dynamic-programming.html-CeAigi5R.js" as="script"><link rel="prefetch" href="/assets/index.html-DFL-hVGk.js" as="script"><link rel="prefetch" href="/assets/index.html-GDT-jMI7.js" as="script"><link rel="prefetch" href="/assets/index.html-FfgzZRla.js" as="script"><link rel="prefetch" href="/assets/index.html-CheKzs5d.js" as="script"><link rel="prefetch" href="/assets/nvm.html-CDBFaDr0.js" as="script"><link rel="prefetch" href="/assets/command.html-CIilOzpl.js" as="script"><link rel="prefetch" href="/assets/index.html-MtCxl5oc.js" as="script"><link rel="prefetch" href="/assets/index.html-DfBbwUov.js" as="script"><link rel="prefetch" href="/assets/spring-boot-hello-world-intro.html-DOZHYfoj.js" as="script"><link rel="prefetch" href="/assets/spring-boot-hello-world.html-DThgfMB5.js" as="script"><link rel="prefetch" href="/assets/spring-boot-oracle.html-BhKIFD_u.js" as="script"><link rel="prefetch" href="/assets/spring-boot-redis-intro.html-CGXQe9at.js" as="script"><link rel="prefetch" href="/assets/spring-boot-redis.html-DgiyrjUt.js" as="script"><link rel="prefetch" href="/assets/spring-boot.html-BaN4KGRT.js" as="script"><link rel="prefetch" href="/assets/spring-framework-aop-impi.html-DD1jas-f.js" as="script"><link rel="prefetch" href="/assets/spring-framework-aop.html-CpZn0FRZ.js" as="script"><link rel="prefetch" href="/assets/spring-framework-ioc-impi.html-BcZQbKqn.js" as="script"><link rel="prefetch" href="/assets/spring-framework-ioc.html-GrzybE67.js" as="script"><link rel="prefetch" href="/assets/spring-framework.html-_k0OhBU6.js" as="script"><link rel="prefetch" href="/assets/common_markdown.html-DhkUxj1W.js" as="script"><link rel="prefetch" href="/assets/common_summary.html-CKt5hPyI.js" as="script"><link rel="prefetch" href="/assets/css.html-CcypYZma.js" as="script"><link rel="prefetch" href="/assets/index.html-J39V0QbR.js" as="script"><link rel="prefetch" href="/assets/plugin.html-vq2SEvqf.js" as="script"><link rel="prefetch" href="/assets/vue-component.html-BuhNmE7D.js" as="script"><link rel="prefetch" href="/assets/vuepress_cloud.html-EYb4WR30.js" as="script"><link rel="prefetch" href="/assets/index.html-DIWIQ5GY.js" as="script"><link rel="prefetch" href="/assets/requirement_v1.html-teGkuExM.js" as="script"><link rel="prefetch" href="/assets/index.html-DJYahuvn.js" as="script"><link rel="prefetch" href="/assets/itexpdf.html-DVF96hC8.js" as="script"><link rel="prefetch" href="/assets/index.html-BszwbGYP.js" as="script"><link rel="prefetch" href="/assets/load-balance.html-qUO_MEE4.js" as="script"><link rel="prefetch" href="/assets/suggest.html-CHW1U6ms.js" as="script"><link rel="prefetch" href="/assets/client.html--r9h10EM.js" as="script"><link rel="prefetch" href="/assets/command.html-BZHiebcB.js" as="script"><link rel="prefetch" href="/assets/curator.html-BkKlLpuE.js" as="script"><link rel="prefetch" href="/assets/index.html-BuWCQr5p.js" as="script"><link rel="prefetch" href="/assets/zkclient.html-DX8c8Zym.js" as="script"><link rel="prefetch" href="/assets/zookeeper_intro.html-CYK-ONFl.js" as="script"><link rel="prefetch" href="/assets/index.html-DLs2VF3R.js" as="script"><link rel="prefetch" href="/assets/multi-tenant.html-40mEAZ2w.js" as="script"><link rel="prefetch" href="/assets/constraint.html-CS9HWnP_.js" as="script"><link rel="prefetch" href="/assets/cursor.html-C_0LgshS.js" as="script"><link rel="prefetch" href="/assets/cursor_intro.html-C7gLzk-5.js" as="script"><link rel="prefetch" href="/assets/index.html-DbiNg0qm.js" as="script"><link rel="prefetch" href="/assets/index.html-MW-fG9GG.js" as="script"><link rel="prefetch" href="/assets/tencent-nginx.html-C30mmIwu.js" as="script"><link rel="prefetch" href="/assets/tencent.html-DWkAsS5F.js" as="script"><link rel="prefetch" href="/assets/index.html-BIOwTFK3.js" as="script"><link rel="prefetch" href="/assets/nginx-problem.html-CE7zDzCP.js" as="script"><link rel="prefetch" href="/assets/nginx.html-CAICL0Sh.js" as="script"><link rel="prefetch" href="/assets/index.html-CTqzHM44.js" as="script"><link rel="prefetch" href="/assets/snowflake.html-p_GyA8eT.js" as="script"><link rel="prefetch" href="/assets/index.html-BP3YI2dX.js" as="script"><link rel="prefetch" href="/assets/404.html-zudC4yRN.js" as="script"><link rel="prefetch" href="/assets/index.html-D7RoIsUw.js" as="script"><link rel="prefetch" href="/assets/index.html-BrR9zzC_.js" as="script"><link rel="prefetch" href="/assets/index.html-k9n05Epq.js" as="script"><link rel="prefetch" href="/assets/index.html-uIlKWb36.js" as="script"><link rel="prefetch" href="/assets/index.html-aijbd4XQ.js" as="script"><link rel="prefetch" href="/assets/index.html-DElNbkP_.js" as="script"><link rel="prefetch" href="/assets/index.html-BdaNxwiz.js" as="script"><link rel="prefetch" href="/assets/index.html-DyIQJv9O.js" as="script"><link rel="prefetch" href="/assets/index.html-Dl0CTFIx.js" as="script"><link rel="prefetch" href="/assets/index.html-CJJkCuUF.js" as="script"><link rel="prefetch" href="/assets/index.html-BZA4Sg9I.js" as="script"><link rel="prefetch" href="/assets/index.html-BM_8Y4u7.js" as="script"><link rel="prefetch" href="/assets/index.html-DeWrsZsK.js" as="script"><link rel="prefetch" href="/assets/index.html-BwniQD1z.js" as="script"><link rel="prefetch" href="/assets/index.html-DuQSwwQv.js" as="script"><link rel="prefetch" href="/assets/index.html-CBySHDgs.js" as="script"><link rel="prefetch" href="/assets/index.html-UPCSnj_x.js" as="script"><link rel="prefetch" href="/assets/index.html-DeWrsZsK.js" as="script"><link rel="prefetch" href="/assets/index.html-BwniQD1z.js" as="script"><link rel="prefetch" href="/assets/index.html-DDg1wbLz.js" as="script"><link rel="prefetch" href="/assets/index.html-Bi2S11zH.js" as="script"><link rel="prefetch" href="/assets/index.html-W-C_Z3YX.js" as="script"><link rel="prefetch" href="/assets/index.html-Bg4ZSR8A.js" as="script"><link rel="prefetch" href="/assets/index.html-CBXChMVm.js" as="script"><link rel="prefetch" href="/assets/index.html-wo3yXJK_.js" as="script"><link rel="prefetch" href="/assets/index.html-CEh1KFD6.js" as="script"><link rel="prefetch" href="/assets/index.html-DgmhTy1V.js" as="script"><link rel="prefetch" href="/assets/index.html-B4b6iyA2.js" as="script"><link rel="prefetch" href="/assets/index.html-DVTa1DZ4.js" as="script"><link rel="prefetch" href="/assets/index.html-Bxsxs-OS.js" as="script"><link rel="prefetch" href="/assets/index.html-MhmqrDz6.js" as="script"><link rel="prefetch" href="/assets/index.html-DYiEwu_N.js" as="script"><link rel="prefetch" href="/assets/index.html-ir77mjBn.js" as="script"><link rel="prefetch" href="/assets/index.html-DE0w_sYp.js" as="script"><link rel="prefetch" href="/assets/index.html-Bpe-lgBA.js" as="script"><link rel="prefetch" href="/assets/index.html-BgLRGfCM.js" as="script"><link rel="prefetch" href="/assets/index.html-GZoarJTS.js" as="script"><link rel="prefetch" href="/assets/index.html-DUuhies1.js" as="script"><link rel="prefetch" href="/assets/index.html-ttbkKenw.js" as="script"><link rel="prefetch" href="/assets/index.html-C0cZ3z2C.js" as="script"><link rel="prefetch" href="/assets/index.html-Bw75SFny.js" as="script"><link rel="prefetch" href="/assets/index.html-CRTjmmh7.js" as="script"><link rel="prefetch" href="/assets/index.html-BAZja2cM.js" as="script"><link rel="prefetch" href="/assets/index.html-DL3RXY81.js" as="script"><link rel="prefetch" href="/assets/index.html-DBebLHTG.js" as="script"><link rel="prefetch" href="/assets/index.html-BfOIIULC.js" as="script"><link rel="prefetch" href="/assets/index.html-BlN6ud16.js" as="script"><link rel="prefetch" href="/assets/mermaid.esm.min-liBca8d0.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><img class="vp-site-logo" src="/images/logo.png" alt="My Blog"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">My Blog</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/resource/" aria-label="资源"><!--[--><!--[--><!--]--><!--]-->资源<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/java_script/" aria-label="JavaScript"><!--[--><!--[--><!--]--><!--]-->JavaScript<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/java/" aria-label="Java"><!--[--><!--[--><!--]--><!--]-->Java<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/spring/" aria-label="Spring"><!--[--><!--[--><!--]--><!--]-->Spring<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/arch/" aria-label="架构"><!--[--><!--[--><!--]--><!--]-->架构<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/db/" aria-label="数据库"><!--[--><!--[--><!--]--><!--]-->数据库<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/algorithm/" aria-label="算法"><!--[--><!--[--><!--]--><!--]-->算法<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/linux/" aria-label="Linux"><!--[--><!--[--><!--]--><!--]-->Linux<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/git/" aria-label="Git"><!--[--><!--[--><!--]--><!--]-->Git<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/vuepress/" aria-label="VuePress"><!--[--><!--[--><!--]--><!--]-->VuePress<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/others/" aria-label="杂项"><!--[--><!--[--><!--]--><!--]-->杂项<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/ai/" aria-label="AI"><!--[--><!--[--><!--]--><!--]-->AI<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/resource/" aria-label="资源"><!--[--><!--[--><!--]--><!--]-->资源<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/java_script/" aria-label="JavaScript"><!--[--><!--[--><!--]--><!--]-->JavaScript<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/java/" aria-label="Java"><!--[--><!--[--><!--]--><!--]-->Java<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/spring/" aria-label="Spring"><!--[--><!--[--><!--]--><!--]-->Spring<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/arch/" aria-label="架构"><!--[--><!--[--><!--]--><!--]-->架构<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/db/" aria-label="数据库"><!--[--><!--[--><!--]--><!--]-->数据库<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/algorithm/" aria-label="算法"><!--[--><!--[--><!--]--><!--]-->算法<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/linux/" aria-label="Linux"><!--[--><!--[--><!--]--><!--]-->Linux<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/git/" aria-label="Git"><!--[--><!--[--><!--]--><!--]-->Git<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/vuepress/" aria-label="VuePress"><!--[--><!--[--><!--]--><!--]-->VuePress<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/others/" aria-label="杂项"><!--[--><!--[--><!--]--><!--]-->杂项<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/ai/" aria-label="AI"><!--[--><!--[--><!--]--><!--]-->AI<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading" href="/java/" aria-label="Java"><!--[--><!--[--><!--]--><!--]-->Java<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading" href="/java/new-features/" aria-label="Java 新特性"><!--[--><!--[--><!--]--><!--]-->Java 新特性<!--[--><!--[--><!--]--><!--]--></a><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/new-features/java-25-features.html" aria-label="Java 25 新特性"><!--[--><!--[--><!--]--><!--]-->Java 25 新特性<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/new-features/java-24-features.html" aria-label="Java 24 新特性"><!--[--><!--[--><!--]--><!--]-->Java 24 新特性<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/java/intermediate/" aria-label="Java 中级"><!--[--><!--[--><!--]--><!--]-->Java 中级<!--[--><!--[--><!--]--><!--]--></a><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/intermediate/multithreading.html" aria-label="Java 多线程编程"><!--[--><!--[--><!--]--><!--]-->Java 多线程编程<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">工具库 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/utils/file_utils.html" aria-label="FileUtils"><!--[--><!--[--><!--]--><!--]-->FileUtils<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/utils/pdf_utils/" aria-label="PDFUtils"><!--[--><!--[--><!--]--><!--]-->PDFUtils<!--[--><!--[--><!--]--><!--]--></a><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/utils/pdf_utils/itexpdf.html" aria-label="itexpdf"><!--[--><!--[--><!--]--><!--]-->itexpdf<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/utils/apache_common.html" aria-label="Apache Common"><!--[--><!--[--><!--]--><!--]-->Apache Common<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/utils/hutool.html" aria-label="hutool"><!--[--><!--[--><!--]--><!--]-->hutool<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">Json <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/json/fastjson2.html" aria-label="fastjson2"><!--[--><!--[--><!--]--><!--]-->fastjson2<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/json/jackson.html" aria-label="Jackson库详解"><!--[--><!--[--><!--]--><!--]-->Jackson库详解<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">ORM <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/orm/mybatis.html" aria-label="MyBatis"><!--[--><!--[--><!--]--><!--]-->MyBatis<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/orm/mybatis-annotation.html" aria-label="MyBatis/MyBatis-Plus注解"><!--[--><!--[--><!--]--><!--]-->MyBatis/MyBatis-Plus注解<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">模块 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/module/mail.html" aria-label="Java 邮件服务"><!--[--><!--[--><!--]--><!--]-->Java 邮件服务<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/module/java_mail.html" aria-label="JavaMail"><!--[--><!--[--><!--]--><!--]-->JavaMail<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/module/java_mail_sender.html" aria-label="JavaMailSender"><!--[--><!--[--><!--]--><!--]-->JavaMailSender<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">其他 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/misc/linked-hash-map-to-object.html" aria-label="LinkedHashMap解析"><!--[--><!--[--><!--]--><!--]-->LinkedHashMap解析<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div id="content"><h1 id="结构化并发-java并发编程的革命性演进" tabindex="-1"><a class="header-anchor" href="#结构化并发-java并发编程的革命性演进"><span>结构化并发：Java并发编程的革命性演进</span></a></h1><blockquote><p>从线程池到结构化并发的范式转换，探索Java并发模型的里程碑式演进</p></blockquote><h2 id="引言" tabindex="-1"><a class="header-anchor" href="#引言"><span>引言</span></a></h2><p>在Java并发编程的历史长河中，从早期的<code>Thread</code>类到线程池，再到现代的虚拟线程，每一次演进都标志着并发模型的重大飞跃。然而，真正革命性的变化来自**结构化并发（Structured Concurrency）**的引入——它不仅改变了我们编写并发代码的方式，更从根本上解决了传统并发编程中的诸多痛点。</p><p>本文将带您深入探索结构化并发的演进历程、核心概念、实战应用，以及它如何重新定义Java并发编程的最佳实践。</p><h2 id="历史演进-从混沌到结构化" tabindex="-1"><a class="header-anchor" href="#历史演进-从混沌到结构化"><span>历史演进：从混沌到结构化</span></a></h2><h3 id="传统并发时代-线程与线程池的困境" tabindex="-1"><a class="header-anchor" href="#传统并发时代-线程与线程池的困境"><span>传统并发时代：线程与线程池的困境</span></a></h3><p>在结构化并发出现之前，Java开发者面临着以下挑战：</p><ul><li>线程泄露 <ul><li>线程启动后，如果没有显式调用 join() 或 interrupt() ， 主线程退出时子线程仍在运行</li></ul></li><li>异常处理困难 <ul><li>子线程抛出的异常 只会被默认的 UncaughtExceptionHandler 捕获并打印 ， 主线程无从感知</li><li>如果主线程需要拿到子任务结果或做回滚，必须：手动在 run() 里 try-catch 并把异常塞进共享变量；主线程周期性轮询；或者自己实现一套 Future / Callable 的雏形。</li></ul></li><li>难以追踪和管理 <ul><li>线程之间没有父子关系 <ul><li>ThreadGroup 只能按名字归类，无法表达“这两个线程属于同一个业务任务”</li><li>在调试器 / jstack 里只能看到两条孤立线程，无法快速判断它们共同服务于哪段业务逻辑</li></ul></li><li>生命周期无法统一 <ul><li>想等两条线程都结束再汇总结果？得自己写 join() 的循环，还要处理中断</li><li>如果中途想取消整个任务，需要逐一 interrupt() ， 无法原子化取消</li></ul></li><li>跨线程上下文传递困难 <ul><li>MDC（日志链路 ID）、SecurityContext 等 ThreadLocal 数据无法自动跟随线程切换，需要手动复制</li></ul></li></ul></li></ul><p><strong>Java 1.0-4时代：原始线程管理</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">// Java 1.0-4：手动线程管理（问题重重）</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ManualThreadDemo</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">fetchUserData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">fetchOrderData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Java 5-18时代：线程池的局限性</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">// Java 5-18：ExecutorService的局限性</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolLimitation</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> user <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">findUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> order <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">fetchOrderData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> user<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> order<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>线程泄露 <ul><li>如果findUser() 抛出异常，那么handle() 在调用user.get() 时也会抛出异常，但fetchOrder() 会继续在自己的线程中运行</li><li>如果执行handle() 的线程被中断，中断不会传播到子任务。findUser() 和fetchOrder() 线程都会泄漏，即使handle() 失败后也会继续运行。</li><li>user.get() -&gt; order.get()，是顺序等待的。即使 fetchOrder() 任务早已失败，handle() 也会被 user.get() 卡住，必须等 findUser() 完成且user.get()返回后，order.get()才会抛出异常，这会产生不必要的等待。</li></ul></li></ul><h3 id="结构化并发时代-革命性的范式转换" tabindex="-1"><a class="header-anchor" href="#结构化并发时代-革命性的范式转换"><span>结构化并发时代：革命性的范式转换</span></a></h3><p><strong>Java 19-20：孵化期探索</strong></p><ul><li><strong>JEP 428</strong> (Java 19)：第一次孵化 <ul><li>首次引入<code>StructuredTaskScope</code>API，支持<code>ShutdownOnFailure</code>和<code>ShutdownOnSuccess</code>策略</li></ul></li><li><strong>JEP 437</strong> (Java 20)：第二次孵化 <ul><li>支持作用域值，任务作用域中创建的线程可继承作用域值</li></ul></li></ul><p><strong>Java 21-25：预览版</strong></p><ul><li><strong>JEP 453</strong>（Java21）：结构化并发预览特性 <ul><li><code>fork()</code>方法返回<code>Subtask</code>而非<code>Future</code>，提供更精细的任务状态查询</li></ul></li><li><strong>JEP 462</strong>（Java22）: 结构化并发（第二次预览）</li><li><strong>JEP 480</strong>（Java23）: 结构化并发（第三次预览）</li><li><strong>JEP 499</strong>（Java24）: 结构化并发（第四次预览）</li><li><strong>JEP 505</strong>（Java25）: 结构化并发（第五次预览）</li></ul><h2 id="核心特性解析" tabindex="-1"><a class="header-anchor" href="#核心特性解析"><span>核心特性解析</span></a></h2><h3 id="结构化任务作用域-structuredtaskscope" tabindex="-1"><a class="header-anchor" href="#结构化任务作用域-structuredtaskscope"><span>结构化任务作用域（StructuredTaskScope）</span></a></h3><p>结构化并发的核心是<code>StructuredTaskScope</code>，它提供了任务生命周期的自动管理。</p><ol><li>创建作用域，并指定关闭策略</li><li>调用<code>fork()</code>在作用域中创建子任务</li><li>调用<code>shutdown()</code>取消所有未完成任务</li></ol><ul><li>当某个子任务遇到无法处理的错误时，调用<code>shutdown()</code>主动请求取消</li><li>父任务也可以调用<code>shutdown()</code>主动取消</li><li><code>ShutdownOnFailure</code>策略会在任一子任务失败时自动调用<code>shutdown()</code></li></ul><ol start="4"><li>调用<code>join()</code>或<code>joinUntil()</code>等待所有子任务完成或取消</li><li>处理异常或获取结果 <ul><li>调用<code>throwIfFailed()</code>抛出第一个失败任务的异常</li><li>调用<code>resultNow()</code>获取已完成任务的结果（如果有）</li></ul></li><li>通过try-with-resources 隐式关闭作用域</li></ol><h4 id="基本使用模式" tabindex="-1"><a class="header-anchor" href="#基本使用模式"><span>基本使用模式</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StructuredConcurrencyDemo</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">fetchUserProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ShutdownOnFailure 策略会在任一子任务失败时自动调用 shutdown()</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructuredTaskScope<span class="token punctuation">.</span>ShutdownOnFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 并行执行多个子任务</span></span>
<span class="line">      <span class="token comment">// Java 19-20 fork()返回Future，Java 21+ fork()返回Subtask</span></span>
<span class="line">      <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> user <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">findUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> order <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">fetchOrderData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 等待所有任务完成或任一失败</span></span>
<span class="line">      scope<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      scope<span class="token punctuation">.</span><span class="token function">throwIfFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 获取结果并组合</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">resultNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">resultNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="作用域关闭策略" tabindex="-1"><a class="header-anchor" href="#作用域关闭策略"><span>作用域关闭策略</span></a></h4><p>有两种关闭策略：</p><ol><li><p>失败时关闭策略：只要有一个任务失败，就关闭所有任务</p></li><li><p>成功时关闭策略：只要有一个任务成功，就关闭所有任务</p></li><li><p>失败时关闭策略</p></li></ol><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShutdownOnFailureDemo</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">fetchCriticalData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructuredTaskScope<span class="token punctuation">.</span>ShutdownOnFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> primary <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">fetchFromPrimary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> secondary <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">fetchFromSecondary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">throwIfFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 任一任务失败则抛出异常</span></span>
<span class="line">            <span class="token keyword">return</span> primary<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 优先使用主数据源</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>成功时关闭策略</li></ol><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">public class ShutdownOnSuccessDemo {</span>
<span class="line">  public static String fetchFirstAvailable() throws Exception {</span>
<span class="line">    try (var scope = new StructuredTaskScope.ShutdownOnSuccess&lt;String&gt;()) {</span>
<span class="line">      scope.fork(() -&gt; fetchFromService1());</span>
<span class="line">      scope.fork(() -&gt; fetchFromService2());</span>
<span class="line">      scope.fork(() -&gt; fetchFromService3());</span>
<span class="line">      scope.join();</span>
<span class="line">      // 返回第一个成功的结果</span>
<span class="line">      return scope.result();</span>
<span class="line">    }</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="subtask-java21" tabindex="-1"><a class="header-anchor" href="#subtask-java21"><span>Subtask(Java21)</span></a></h3><p>从JEP 453开始，StructuredTaskScope::fork(...)方法返回一个Subtask，而不是Future。 Subtask提供了比Future更丰富的方法来查询任务状态。</p><h4 id="核心方法" tabindex="-1"><a class="header-anchor" href="#核心方法"><span>核心方法</span></a></h4><ol><li><code>get()</code>：获取任务结果，如果任务未完成，则阻塞直到完成；如果任务失败或取消，则抛出异常。与Future.get()类似</li><li><code>state()</code>：获取任务状态，返回Subtask.State枚举值，比 Future.isDone() 提供更精细的信息。</li></ol><ul><li>UNAVAILABLE：任务未开始或仍在运行</li><li>SUCCESS：任务已成功完成</li><li>FAILED：任务因异常而失败</li><li>CANCELLED：任务已被取消</li></ul><ol start="3"><li><code>exception()</code>：如果任务因异常而完成，返回该异常。否则返回 null。</li><li><code>toString()</code>：返回任务的字符串表示形式，通常包含状态信息。</li></ol><h4 id="代码对比" tabindex="-1"><a class="header-anchor" href="#代码对比"><span>代码对比</span></a></h4><p><strong>使用 Future (传统方式)</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> successFuture <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> failureFuture <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> </span>
<span class="line">    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Boom!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 状态查询模糊</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>successFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 是成功了？还是失败了？还是取消了？不知道，必须调用 get()</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 异常处理繁琐，需要捕获 ExecutionException 并提取真实异常</span></span>
<span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> result <span class="token operator">=</span> failureFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Throwable</span> realCause <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Task failed: &quot;</span> <span class="token operator">+</span> realCause<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>使用 Subtask (结构化并发)</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructuredTaskScope<span class="token punctuation">.</span>ShutdownOnFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> successSubtask <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> failureSubtask <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Boom!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  scope<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 状态查询清晰明了</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>successSubtask<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Subtask<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Task succeeded: &quot;</span> <span class="token operator">+</span> successSubtask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// 异常处理直接了当</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>failureSubtask<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Subtask<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span><span class="token constant">FAILED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Throwable</span> cause <span class="token operator">=</span> failureSubtask<span class="token punctuation">.</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 直接获取原始异常</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Task failed: &quot;</span> <span class="token operator">+</span> cause<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="异常传播与取消机制" tabindex="-1"><a class="header-anchor" href="#异常传播与取消机制"><span>异常传播与取消机制</span></a></h3><p>结构化并发提供了优雅的异常处理机制：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionHandlingDemo</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">UserProfile</span> <span class="token function">fetchUserProfileWithFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructuredTaskScope<span class="token punctuation">.</span>ShutdownOnFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 并行获取用户数据</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userTask <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">fetchUserFromAPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ordersTask <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">fetchUserOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                scope<span class="token punctuation">.</span><span class="token function">throwIfFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserProfile</span><span class="token punctuation">(</span>userTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ordersTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 优雅降级：使用缓存数据</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token function">fetchFromCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="与虚拟线程的完美结合" tabindex="-1"><a class="header-anchor" href="#与虚拟线程的完美结合"><span>与虚拟线程的完美结合</span></a></h3><p>结构化并发与虚拟线程的结合创造了强大的并发模型：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VirtualThreadIntegration</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">processLargeDataset</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructuredTaskScope<span class="token punctuation">.</span>ShutdownOnFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 使用虚拟线程并行处理数据块</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Subtask</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>chunk <span class="token operator">-&gt;</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">processChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        scope<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        scope<span class="token punctuation">.</span><span class="token function">throwIfFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> tasks<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Subtask</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newVirtualThreadPerTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="实战案例对比" tabindex="-1"><a class="header-anchor" href="#实战案例对比"><span>实战案例对比</span></a></h2><h3 id="案例1-微服务聚合api" tabindex="-1"><a class="header-anchor" href="#案例1-微服务聚合api"><span>案例1：微服务聚合API</span></a></h3><p><strong>传统方式 vs 结构化并发</strong> 从下面案例对比看出：</p><ol><li><code>scope.throwIfFailed()</code>代替了传统方式的复杂异常处理，一行代码即可取消所有任务</li><li><code>Subtask.get()</code>代替了传统方式的<code>Future.get()</code>，无需传参，API更简洁</li></ol><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">// ❌ 传统方式：复杂且易出错</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TraditionalAggregationService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">UserDashboard</span> <span class="token function">getDashboard</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userFuture <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> userService<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ordersFuture <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> orderService<span class="token punctuation">.</span><span class="token function">getOrders</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Notification</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> notifsFuture <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> notificationService<span class="token punctuation">.</span><span class="token function">getNotifications</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserDashboard</span><span class="token punctuation">(</span></span>
<span class="line">                userFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                ordersFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                notifsFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 取消所有任务</span></span>
<span class="line">            userFuture<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ordersFuture<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            notifsFuture<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">throw</span> e<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ✅ 结构化并发：简洁且可靠</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StructuredAggregationService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">UserDashboard</span> <span class="token function">getDashboard</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructuredTaskScope<span class="token punctuation">.</span>ShutdownOnFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userTask <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> userService<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ordersTask <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> orderService<span class="token punctuation">.</span><span class="token function">getOrders</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Notification</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> notifsTask <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> notificationService<span class="token punctuation">.</span><span class="token function">getNotifications</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">throwIfFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserDashboard</span><span class="token punctuation">(</span>userTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ordersTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> notifsTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="案例2-数据流处理管道" tabindex="-1"><a class="header-anchor" href="#案例2-数据流处理管道"><span>案例2：数据流处理管道</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataProcessingPipeline</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ProcessingResult</span> <span class="token function">processTransaction</span><span class="token punctuation">(</span><span class="token class-name">Transaction</span> tx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructuredTaskScope<span class="token punctuation">.</span>ShutdownOnFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 并行验证</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> fraudCheck <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> fraudService<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> complianceCheck <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> complianceService<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 并行处理</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> riskScore <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> riskEngine<span class="token punctuation">.</span><span class="token function">calculate</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> notification <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> notificationService<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">throwIfFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ProcessingResult</span><span class="token punctuation">(</span></span>
<span class="line">                fraudCheck<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                complianceCheck<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                riskScore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                notification<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="设计模式应用" tabindex="-1"><a class="header-anchor" href="#设计模式应用"><span>设计模式应用</span></a></h3><h4 id="_1-扇出-扇入模式-fan-out-fan-in" tabindex="-1"><a class="header-anchor" href="#_1-扇出-扇入模式-fan-out-fan-in"><span>1. 扇出-扇入模式（Fan-out/Fan-in）</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FanOutFanInPattern</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">parallelMap</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> mapper<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructuredTaskScope<span class="token punctuation">.</span>ShutdownOnFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Subtask</span><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> items<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> mapper<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">throwIfFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">return</span> tasks<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Subtask</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-超时处理模式" tabindex="-1"><a class="header-anchor" href="#_2-超时处理模式"><span>2. 超时处理模式</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeoutHandlingPattern</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">fetchWithTimeout</span><span class="token punctuation">(</span><span class="token class-name">Duration</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructuredTaskScope<span class="token punctuation">.</span>ShutdownOnFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> primary <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">fetchFromPrimary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fallback <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">fetchFromFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">boolean</span> completed <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">joinUntil</span><span class="token punctuation">(</span><span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plus</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>completed<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">(</span><span class="token string">&quot;操作超时&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">throwIfFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> primary<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Subtask<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span> <span class="token operator">?</span> primary<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> fallback<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="迁移策略" tabindex="-1"><a class="header-anchor" href="#迁移策略"><span>迁移策略</span></a></h3><h4 id="逐步迁移路径" tabindex="-1"><a class="header-anchor" href="#逐步迁移路径"><span>逐步迁移路径</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">// 阶段1：识别传统并发代码</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LegacyService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">oldMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 阶段2：包装为结构化并发</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransitionalService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">newMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructuredTaskScope<span class="token punctuation">.</span>ShutdownOnFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> task <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">throwIfFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> task<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 阶段3：充分利用结构化特性</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ModernService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">optimizedMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructuredTaskScope<span class="token punctuation">.</span>ShutdownOnFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 多个相关任务并行执行</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> task1 <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">fetchPart1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Subtask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> task2 <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">fetchPart2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">throwIfFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">combine</span><span class="token punctuation">(</span>task1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>结构化并发代表了Java并发编程的范式转换，从<strong>手动管理</strong>转向<strong>自动生命周期管理</strong>，从<strong>复杂异常处理</strong>转向<strong>优雅传播机制</strong>。</p><blockquote><p><strong>参考资料</strong>：</p><ul><li><a href="https://openjdk.org/jeps/428" target="_blank" rel="noopener noreferrer">JEP 428: Structured Concurrency (Incubator)</a></li><li><a href="https://openjdk.org/jeps/437" target="_blank" rel="noopener noreferrer">JEP 437: Structured Concurrency (Second Incubator)</a></li><li><a href="https://openjdk.org/jeps/453" target="_blank" rel="noopener noreferrer">JEP 453: Structured Concurrency (Preview)</a></li><li><a href="https://openjdk.org/jeps/462" target="_blank" rel="noopener noreferrer">JEP 462: Structured Concurrency (Second Preview)</a></li><li><a href="https://openjdk.org/jeps/480" target="_blank" rel="noopener noreferrer">JEP 480: Structured Concurrency (Third Preview)</a></li><li><a href="https://openjdk.org/jeps/499" target="_blank" rel="noopener noreferrer">JEP 499: Structured Concurrency (Fourth Preview)</a></li><li><a href="https://openjdk.org/jeps/505" target="_blank" rel="noopener noreferrer">JEP 505: Structured Concurrency (Fifth Preview)</a></li></ul></blockquote></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">最近更新：: </span><time class="meta-item-info" datetime="2025-09-15T08:16:08.000Z" data-allow-mismatch>2025/9/15 08:16</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 3036190149@qq.com">zhaomy</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DhQSeJGz.js" defer></script>
  </body>
</html>
